import{c as ue,a as xe,r as t,h as ge,j as e,a3 as je,B as x,C as I,q as K,t as O,ae as $,v as q,b as U,a4 as l,I as N,E as V,G as _,H as Q,J as G,K as g,a5 as Y,aK as pe,aL as fe,aM as v,d as Ne,O as W,Q as J}from"./index-B6B5-wqG.js";import{u as X}from"./useMutation-DUKQItlV.js";import{T as ve}from"./textarea-B8jmdzpK.js";import{S as ye}from"./switch-7TT_84Ex.js";import{A as we,h as be,a as Ce,b as Se,c as ke,d as Te,e as Me,f as Fe,g as Ae}from"./alert-dialog-DGaBQvry.js";import{B as d}from"./badge-BCk9M62I.js";import{S as De}from"./skeleton-QnbRUKoU.js";import{A as Le}from"./arrow-left-BpE3PuIj.js";import{U as Z}from"./users-d7mTDrPY.js";import{P as ee}from"./paw-print-CXCaKFJL.js";import{B as se}from"./building-2-BRlfl8Dq.js";import{G as y}from"./globe-DO5GdCV5.js";import{C as te}from"./calendar-BCAUg3Hi.js";import{R as ae}from"./refresh-cw-Rle-BtDm.js";import{S as Pe}from"./send-BV-BHk2s.js";import{T as He}from"./trash-2-CgsLVNDK.js";import{C as Ee}from"./circle-x-CX15qlya.js";import{C as Be}from"./circle-check-vxY-lgNo.js";import{f as p}from"./format-CoLFXwEe.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const C=ue("CalendarClock",[["path",{d:"M21 7.5V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h3.5",key:"1osxxc"}],["path",{d:"M16 2v4",key:"4m81vk"}],["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M3 10h5",key:"r794hk"}],["path",{d:"M17.5 17.5 16 16.3V14",key:"akvzfd"}],["circle",{cx:"16",cy:"16",r:"6",key:"qoo3c4"}]]);function ts(){const{toast:a}=xe(),[o,S]=t.useState(""),[h,k]=t.useState(""),[T,M]=t.useState("all"),[F,A]=t.useState("all"),[D,L]=t.useState(""),[m,P]=t.useState(!1),[n,H]=t.useState(""),[j,E]=t.useState(""),[w,B]=t.useState(1),[r,ie]=t.useState("all"),{data:u,isLoading:le,refetch:ne}=ge({queryKey:["/api/admin/notifications",w]}),R=(u==null?void 0:u.broadcasts)||[],c=u==null?void 0:u.pagination,z=R.filter(s=>r==="all"?!0:r==="scheduled"?s.status==="scheduled":r==="sent"?s.status==="sent":r==="failed"?s.status==="failed"||s.status==="cancelled":!0),b=X({mutationFn:async s=>W("POST","/api/admin/notifications/broadcast",{title:s.title,message:s.message,targetRole:s.targetAudience==="all"?null:s.targetAudience,targetLanguage:s.targetLanguage==="all"?null:s.targetLanguage,url:s.url||void 0,scheduledFor:s.scheduledFor||null}),onSuccess:(s,i)=>{a({title:i.scheduledFor?"Notification Scheduled":"Notification Sent",description:i.scheduledFor?"Your notification has been scheduled successfully.":"Your broadcast notification has been sent successfully."}),ce(),J.invalidateQueries({queryKey:["/api/admin/notifications"]})},onError:s=>{a({title:"Failed",description:s.message||"Failed to process notification. Please try again.",variant:"destructive"})}}),re=X({mutationFn:async s=>W("DELETE",`/api/admin/notifications/${s}`),onSuccess:()=>{a({title:"Notification Cancelled",description:"The scheduled notification has been cancelled."}),J.invalidateQueries({queryKey:["/api/admin/notifications"]})},onError:s=>{a({title:"Failed to Cancel",description:s.message||"Failed to cancel notification. Please try again.",variant:"destructive"})}}),ce=()=>{S(""),k(""),L(""),M("all"),A("all"),P(!1),H(""),E("")},de=()=>{if(!o.trim()||!h.trim()){a({title:"Missing Fields",description:"Please provide both title and message.",variant:"destructive"});return}if(o.length>100){a({title:"Title Too Long",description:"Title must be 100 characters or less.",variant:"destructive"});return}if(h.length>500){a({title:"Message Too Long",description:"Message must be 500 characters or less.",variant:"destructive"});return}let s=null;if(m){if(!n||!j){a({title:"Missing Schedule",description:"Please select both date and time for scheduling.",variant:"destructive"});return}const i=new Date(`${n}T${j}`);if(i<=new Date){a({title:"Invalid Schedule",description:"Scheduled time must be in the future.",variant:"destructive"});return}s=i.toISOString()}b.mutate({title:o.trim(),message:h.trim(),targetAudience:T,targetLanguage:F,url:D.trim(),scheduledFor:s})},oe=()=>new Date().toISOString().split("T")[0],he=()=>{if(!n)return"";const s=new Date().toISOString().split("T")[0];if(n===s){const i=new Date;return i.setMinutes(i.getMinutes()+5),i.toTimeString().slice(0,5)}return"00:00"},me=s=>{switch(s){case"sent":return e.jsxs(d,{className:"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200",children:[e.jsx(Be,{className:"h-3 w-3 mr-1"}),"Sent"]});case"pending":return e.jsxs(d,{className:"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200",children:[e.jsx(Y,{className:"h-3 w-3 mr-1"}),"Sending"]});case"scheduled":return e.jsxs(d,{className:"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200",children:[e.jsx(C,{className:"h-3 w-3 mr-1"}),"Scheduled"]});case"failed":return e.jsxs(d,{className:"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200",children:[e.jsx(Ee,{className:"h-3 w-3 mr-1"}),"Failed"]});case"cancelled":return e.jsxs(d,{className:"bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200",children:[e.jsx(Ne,{className:"h-3 w-3 mr-1"}),"Cancelled"]});default:return e.jsx(d,{variant:"outline",children:s})}},f=R.filter(s=>s.status==="scheduled").length;return e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900",children:e.jsxs("div",{className:"container mx-auto px-4 py-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(je,{href:"/admin",children:e.jsx(x,{variant:"ghost",size:"icon","data-testid":"button-back-admin",children:e.jsx(Le,{className:"h-5 w-5"})})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white","data-testid":"text-page-title",children:"Push Notifications"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 text-sm",children:"Send or schedule broadcast notifications to app users"})]})]}),f>0&&e.jsxs(d,{variant:"outline",className:"text-blue-600 border-blue-300","data-testid":"badge-scheduled-count",children:[e.jsx(C,{className:"h-3 w-3 mr-1"}),f," scheduled"]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(I,{"data-testid":"card-compose-notification",children:[e.jsxs(K,{children:[e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx($,{className:"h-5 w-5"}),"Compose Notification"]}),e.jsx(q,{children:"Create and send or schedule a push notification"})]}),e.jsxs(U,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"title",children:"Title *"}),e.jsx(N,{id:"title",placeholder:"Notification title...",value:o,onChange:s=>S(s.target.value),maxLength:100,"data-testid":"input-notification-title"}),e.jsxs("p",{className:"text-xs text-gray-500",children:[o.length,"/100 characters"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"message",children:"Message *"}),e.jsx(ve,{id:"message",placeholder:"Notification message...",value:h,onChange:s=>k(s.target.value),maxLength:500,rows:4,"data-testid":"input-notification-message"}),e.jsxs("p",{className:"text-xs text-gray-500",children:[h.length,"/500 characters"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"targetAudience",children:"Target Audience"}),e.jsxs(V,{value:T,onValueChange:M,children:[e.jsx(_,{"data-testid":"select-target-audience",children:e.jsx(Q,{})}),e.jsxs(G,{children:[e.jsx(g,{value:"all",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"h-4 w-4"}),"All Users"]})}),e.jsx(g,{value:"pet_owner",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ee,{className:"h-4 w-4"}),"Pet Owners"]})}),e.jsx(g,{value:"hospital_clinic",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-4 w-4"}),"Hospitals / Clinics"]})})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"targetLanguage",children:"Language Filter"}),e.jsxs(V,{value:F,onValueChange:A,children:[e.jsx(_,{"data-testid":"select-target-language",children:e.jsx(Q,{})}),e.jsxs(G,{children:[e.jsx(g,{value:"all",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(y,{className:"h-4 w-4"}),"All Languages"]})}),e.jsx(g,{value:"en",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(y,{className:"h-4 w-4"}),"English Users"]})}),e.jsx(g,{value:"zh-HK",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(y,{className:"h-4 w-4"}),"Chinese Users (繁中)"]})})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"url",children:"Click URL (optional)"}),e.jsx(N,{id:"url",placeholder:"https://petsos.site/...",value:D,onChange:s=>L(s.target.value),"data-testid":"input-notification-url"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Where users go when they click the notification"})]}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsxs(l,{htmlFor:"schedule-toggle",className:"flex items-center gap-2",children:[e.jsx(te,{className:"h-4 w-4"}),"Schedule for later"]}),e.jsx("p",{className:"text-xs text-gray-500",children:"Send at a specific date and time"})]}),e.jsx(ye,{id:"schedule-toggle",checked:m,onCheckedChange:P,"data-testid":"switch-schedule-toggle"})]}),m&&e.jsxs("div",{className:"grid grid-cols-2 gap-3 p-3 bg-blue-50 dark:bg-blue-950 rounded-lg",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(l,{htmlFor:"scheduled-date",className:"text-xs",children:"Date"}),e.jsx(N,{id:"scheduled-date",type:"date",value:n,onChange:s=>H(s.target.value),min:oe(),className:"h-9","data-testid":"input-scheduled-date"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(l,{htmlFor:"scheduled-time",className:"text-xs",children:"Time"}),e.jsx(N,{id:"scheduled-time",type:"time",value:j,onChange:s=>E(s.target.value),min:he(),className:"h-9","data-testid":"input-scheduled-time"})]}),n&&j&&e.jsxs("p",{className:"col-span-2 text-xs text-blue-700 dark:text-blue-300",children:["Will send on ",p(new Date(`${n}T${j}`),"MMM d, yyyy 'at' h:mm a")]})]})]}),e.jsx(x,{onClick:de,disabled:b.isPending||!o.trim()||!h.trim(),className:`w-full ${m?"bg-blue-600 hover:bg-blue-700":"bg-red-600 hover:bg-red-700"}`,"data-testid":"button-send-notification",children:b.isPending?e.jsxs(e.Fragment,{children:[e.jsx(ae,{className:"h-4 w-4 mr-2 animate-spin"}),m?"Scheduling...":"Sending..."]}):m?e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"h-4 w-4 mr-2"}),"Schedule Notification"]}):e.jsxs(e.Fragment,{children:[e.jsx(Pe,{className:"h-4 w-4 mr-2"}),"Send Now"]})})]})]}),e.jsxs(I,{"data-testid":"card-notification-history",children:[e.jsx(K,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(Y,{className:"h-5 w-5"}),"Notifications"]}),e.jsx(q,{children:"All scheduled and sent notifications"})]}),e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>ne(),"data-testid":"button-refresh-history",children:e.jsx(ae,{className:"h-4 w-4"})})]})}),e.jsxs(U,{children:[e.jsx(pe,{value:r,onValueChange:ie,className:"mb-4",children:e.jsxs(fe,{className:"grid w-full grid-cols-4",children:[e.jsx(v,{value:"all","data-testid":"tab-all",children:"All"}),e.jsxs(v,{value:"scheduled","data-testid":"tab-scheduled",children:["Scheduled",f>0&&e.jsx("span",{className:"ml-1 text-xs bg-blue-100 text-blue-800 px-1.5 rounded-full",children:f})]}),e.jsx(v,{value:"sent","data-testid":"tab-sent",children:"Sent"}),e.jsx(v,{value:"failed","data-testid":"tab-failed",children:"Other"})]})}),le?e.jsx("div",{className:"space-y-3",children:[1,2,3].map(s=>e.jsx(De,{className:"h-16 w-full"},s))}):z.length>0?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-3 max-h-[400px] overflow-y-auto",children:z.map(s=>e.jsxs("div",{className:"p-3 border rounded-lg bg-white dark:bg-gray-800","data-testid":`notification-${s.id}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-white truncate",children:s.title}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 line-clamp-2",children:s.message})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[me(s.status),s.status==="scheduled"&&e.jsxs(we,{children:[e.jsx(be,{asChild:!0,children:e.jsx(x,{variant:"ghost",size:"icon",className:"h-7 w-7 text-red-500 hover:text-red-700","data-testid":`button-cancel-${s.id}`,children:e.jsx(He,{className:"h-4 w-4"})})}),e.jsxs(Ce,{children:[e.jsxs(Se,{children:[e.jsx(ke,{children:"Cancel Scheduled Notification?"}),e.jsxs(Te,{children:['This will cancel the notification "',s.title,'" scheduled for'," ",s.scheduledFor?p(new Date(s.scheduledFor),"MMM d, yyyy 'at' h:mm a"):"later",". This action cannot be undone."]})]}),e.jsxs(Me,{children:[e.jsx(Fe,{"data-testid":"button-cancel-dialog-cancel",children:"Keep it"}),e.jsx(Ae,{onClick:()=>re.mutate(s.id),className:"bg-red-600 hover:bg-red-700","data-testid":"button-confirm-cancel",children:"Yes, Cancel"})]})]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-4 mt-2 text-xs text-gray-500",children:[s.status==="scheduled"&&s.scheduledFor?e.jsxs("span",{className:"flex items-center gap-1 text-blue-600",children:[e.jsx(C,{className:"h-3 w-3"}),p(new Date(s.scheduledFor),"MMM d, HH:mm")]}):e.jsx("span",{children:s.sentAt?p(new Date(s.sentAt),"MMM d, HH:mm"):p(new Date(s.createdAt),"MMM d, HH:mm")}),s.recipientCount!==null&&s.recipientCount!==void 0&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Z,{className:"h-3 w-3"}),s.recipientCount," recipients"]}),s.targetLanguage&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(y,{className:"h-3 w-3"}),s.targetLanguage==="zh-HK"?"繁中":"EN"]}),s.targetRole&&e.jsxs("span",{className:"flex items-center gap-1",children:[s.targetRole==="pet_owner"?e.jsx(ee,{className:"h-3 w-3"}):e.jsx(se,{className:"h-3 w-3"}),s.targetRole==="pet_owner"?"Pet Owners":"Clinics"]})]})]},s.id))}),c&&c.totalPages>1&&e.jsxs("div",{className:"flex items-center justify-between mt-4 pt-4 border-t",children:[e.jsxs("p",{className:"text-xs text-gray-500",children:["Page ",c.page," of ",c.totalPages," (",c.total," total)"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{variant:"outline",size:"sm",onClick:()=>B(s=>Math.max(1,s-1)),disabled:w===1,"data-testid":"button-prev-page",children:"Previous"}),e.jsx(x,{variant:"outline",size:"sm",onClick:()=>B(s=>Math.min(c.totalPages,s+1)),disabled:w>=c.totalPages,"data-testid":"button-next-page",children:"Next"})]})]})]}):e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx($,{className:"h-12 w-12 mx-auto mb-3 opacity-30"}),e.jsx("p",{children:r==="scheduled"?"No scheduled notifications":r==="sent"?"No sent notifications yet":"No notifications yet"})]})]})]})]})]})})}export{ts as default};
