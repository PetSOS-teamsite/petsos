import{r as i,j as e,W as x,aG as k,a as M,h as P,C as u,q as p,t as g,v as j,b as f,$ as v,I as N,B as b,d as y,G as W,H as I}from"./index-DwyYRZ5p.js";import{u as D}from"./useMutation-qDWMbsfK.js";import{B as w}from"./badge-BMrQ0xDH.js";import{R as C}from"./refresh-cw-C1dE4zng.js";import{S as R}from"./send-DqE-pDFx.js";import{C as q}from"./circle-check-VAEX32bm.js";const B=k("relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",{variants:{variant:{default:"bg-background text-foreground",destructive:"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive"}},defaultVariants:{variant:"default"}}),o=i.forwardRef(({className:t,variant:r,...d},l)=>e.jsx("div",{ref:l,role:"alert",className:x(B({variant:r}),t),...d}));o.displayName="Alert";const E=i.forwardRef(({className:t,...r},d)=>e.jsx("h5",{ref:d,className:x("mb-1 font-medium leading-none tracking-tight",t),...r}));E.displayName="AlertTitle";const m=i.forwardRef(({className:t,...r},d)=>e.jsx("div",{ref:d,className:x("text-sm [&_p]:leading-relaxed",t),...r}));m.displayName="AlertDescription";function Q(){var h;const{toast:t}=M(),[r,d]=i.useState("+85265727136"),[l,A]=i.useState("PetSOS WhatsApp Test"),a=D({mutationFn:s=>W("POST","/api/admin/test-whatsapp",s),onSuccess:s=>{s.success&&(t({title:"Test Successful",description:"WhatsApp message sent successfully!"}),I.invalidateQueries({queryKey:["/api/admin/failed-messages"]}))},onError:s=>{console.error("WhatsApp test error:",s),t({title:"Test Failed",description:s.message||"Failed to send test message",variant:"destructive"})}}),{data:n,isLoading:c,refetch:T}=P({queryKey:["/api/admin/failed-messages"]}),S=()=>{a.mutate({phoneNumber:r,message:l})};return e.jsxs("div",{className:"container mx-auto p-6 max-w-6xl",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold mb-2",children:"WhatsApp Diagnostics"}),e.jsx("p",{className:"text-muted-foreground",children:"Test your WhatsApp Business API connection and view message failures"})]}),e.jsxs(u,{className:"mb-6",children:[e.jsxs(p,{children:[e.jsx(g,{children:"Test WhatsApp Connection"}),e.jsx(j,{children:"Send a test message to verify your WhatsApp credentials are working"})]}),e.jsxs(f,{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{htmlFor:"phone",children:"Phone Number"}),e.jsx(N,{id:"phone",placeholder:"+85265727136",value:r,onChange:s=>d(s.target.value),"data-testid":"input-test-phone"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{htmlFor:"message",children:"Test Message"}),e.jsx(N,{id:"message",placeholder:"Test message",value:l,onChange:s=>A(s.target.value),"data-testid":"input-test-message"})]})]}),e.jsx(b,{onClick:S,disabled:a.isPending,className:"w-full sm:w-auto","data-testid":"button-test-whatsapp",children:a.isPending?e.jsxs(e.Fragment,{children:[e.jsx(C,{className:"mr-2 h-4 w-4 animate-spin"}),"Testing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"mr-2 h-4 w-4"}),"Send Test Message"]})}),a.data&&e.jsxs(o,{className:a.data.success?"border-green-500 bg-green-50 dark:bg-green-950":"border-red-500 bg-red-50 dark:bg-red-950","data-testid":"alert-test-result",children:[a.data.success?e.jsx(q,{className:"h-4 w-4 text-green-600"}):e.jsx(y,{className:"h-4 w-4 text-red-600"}),e.jsxs(m,{children:[e.jsx("div",{className:"font-semibold mb-2",children:a.data.success?"✅ Success!":"❌ Failed"}),a.data.success?e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsx("p",{children:a.data.message}),((h=a.data.debugInfo)==null?void 0:h.messageId)&&e.jsxs("p",{className:"font-mono text-xs",children:["Message ID:"," ",a.data.debugInfo.messageId]})]}):e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsx("p",{className:"font-semibold",children:a.data.error}),a.data.statusCode&&e.jsxs("p",{children:["Status Code:"," ",a.data.statusCode]}),a.data.details&&e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"font-semibold",children:"Details:"}),e.jsx("pre",{className:"mt-1 p-2 bg-white dark:bg-gray-900 rounded text-xs overflow-x-auto",children:JSON.stringify(a.data.details,null,2)})]})]})]})]}),a.error&&e.jsxs(o,{className:"border-red-500 bg-red-50 dark:bg-red-950",children:[e.jsx(y,{className:"h-4 w-4 text-red-600"}),e.jsxs(m,{children:[e.jsx("p",{className:"font-semibold",children:"Request Error"}),e.jsx("p",{className:"text-sm",children:a.error.message||"Failed to connect to server"})]})]})]})]}),e.jsxs(u,{children:[e.jsxs(p,{className:"flex flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(g,{children:"Failed Messages"}),e.jsx(j,{children:"Messages that failed to send via WhatsApp API"})]}),e.jsx(b,{variant:"outline",size:"sm",onClick:()=>T(),disabled:c,"data-testid":"button-refresh-failed",children:e.jsx(C,{className:`h-4 w-4 ${c?"animate-spin":""}`})})]}),e.jsx(f,{children:c?e.jsx("p",{className:"text-muted-foreground text-center py-8",children:"Loading..."}):n&&n.total>0?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(w,{variant:"destructive","data-testid":"badge-failed-count",children:[n.total," Failed"]})}),e.jsx("div",{className:"space-y-3",children:n.messages.map((s,F)=>e.jsxs("div",{className:"border rounded-lg p-4 space-y-2","data-testid":`failed-message-${F}`,children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("p",{className:"font-semibold",children:["To: ",s.recipient]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Type: ",s.messageType]})]}),e.jsxs(w,{variant:"outline",children:[s.retryCount,"/3 retries"]})]}),s.error&&e.jsxs("p",{className:"text-sm text-red-600 dark:text-red-400",children:["Error: ",s.error]}),s.failedAt&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Failed at: ",new Date(s.failedAt).toLocaleString()]})]},s.id))})]}):e.jsx("p",{className:"text-muted-foreground text-center py-8",children:"No failed messages found"})})]})]})}export{Q as default};
