import{e as re,f as le,a as de,u as oe,r as d,h as F,g as ce,j as e,_ as pe,B as o,C as z,q as B,t as K,v as Q,F as me,w as c,x as p,y as m,z as x,I as w,A as h,a1 as xe,a2 as he,a3 as ue,a4 as ge,a5 as je,D as fe,W as Y,X as be,b as W,o as ve,s as j,ab as Z,a7 as ye,G as H,H as O,J as we}from"./index-DSfXJrMH.js";import{u as L}from"./useMutation-Cr219pYB.js";import{T as Ne}from"./textarea-BoweR-O6.js";import{B as Ce,P as Se,a as Pe,C as De,b as _e,c as Ve,d as Ie,e as ke,f as Ae,g as Te,h as Ee}from"./BreedCombobox-Bo4Hsfeg.js";import{D as Fe,f as He,a as Oe,b as Le,c as qe}from"./dialog-DVNSF8fN.js";import{A as Me,a as $e,b as ze,c as Be,d as Ke,e as Qe,f as Ye,g as We}from"./alert-dialog-wxMcagxD.js";import{A as Ze}from"./arrow-left-B5_XZNND.js";import{P as G}from"./paw-print-BoIjn5Cl.js";import{P as J}from"./plus-DrdFOOcl.js";import{P as Ge}from"./pencil-GTbF4EPR.js";import{T as Je}from"./trash-2-DJdNRrn9.js";import"./index-BKY5CHHC.js";import"./search-qxig8uw6.js";const Re={dog:{en:"Dog",zh:"ç‹—"},cat:{en:"Cat",zh:"è²“"}},Xe=a=>ve({name:j().min(1,a("pets.validation.name_required","Pet name is required")),species:j().min(1,a("pets.validation.species_required","Species is required")),breed:j().optional(),age:Z.number().positive().optional(),weight:Z.number().positive().optional(),medicalNotes:j().optional(),lastVisitHospitalId:j().optional(),lastVisitDate:j().optional()});function xs(){const{user:a,isLoading:N}=re(),[,C]=le(),{toast:u}=de(),{t,language:f}=oe(),R=Xe(t),[X,g]=d.useState(!1),[b,v]=d.useState(null),[S,P]=d.useState(null),[D,_]=d.useState(""),[U,q]=d.useState(!1),[Ue,ee]=d.useState("select"),{data:V,isLoading:I}=F({queryKey:["/api/users",a==null?void 0:a.id],enabled:!!(a!=null&&a.id)}),{data:M=[],isLoading:se}=F({queryKey:["/api/users",a==null?void 0:a.id,"pets"],enabled:!!(a!=null&&a.id)}),{data:k=[]}=F({queryKey:["/api/clinics"]}),n=ce({resolver:ye(R),defaultValues:{name:"",species:"",breed:"",age:void 0,weight:void 0,medicalNotes:"",lastVisitHospitalId:void 0,lastVisitDate:void 0}}),y=n.watch("species");d.useEffect(()=>{y&&y!==D&&(_(y),n.setValue("breed",""))},[y,D,n]);const A=L({mutationFn:async s=>{const i={...s,userId:a==null?void 0:a.id,weight:s.weight!==void 0?String(s.weight):void 0,lastVisitDate:s.lastVisitDate?new Date(s.lastVisitDate).toISOString():void 0,lastVisitHospitalId:s.lastVisitHospitalId&&s.lastVisitHospitalId.trim()!==""?s.lastVisitHospitalId:void 0};return await(await H("POST","/api/pets",i)).json()},onSuccess:(s,i)=>{O.invalidateQueries({queryKey:["/api/users",a==null?void 0:a.id,"pets"]}),we.trackPetCreation({petType:i.species,breed:i.breed}),u({title:t("pets.success.add","Pet added successfully!"),description:t("pets.success.add_desc","Your pet has been added to your profile.")}),g(!1),n.reset()},onError:s=>{u({title:t("pets.error.add","Failed to add pet"),description:s.message,variant:"destructive"})}}),T=L({mutationFn:async({id:s,data:i})=>{const l={...i,weight:i.weight!==void 0?String(i.weight):void 0,lastVisitDate:i.lastVisitDate?new Date(i.lastVisitDate).toISOString():void 0,lastVisitHospitalId:i.lastVisitHospitalId&&i.lastVisitHospitalId.trim()!==""?i.lastVisitHospitalId:void 0};return await(await H("PATCH",`/api/pets/${s}`,l)).json()},onSuccess:()=>{O.invalidateQueries({queryKey:["/api/users",a==null?void 0:a.id,"pets"]}),u({title:t("pets.success.update","Pet updated successfully!"),description:t("pets.success.update_desc","Your pet's information has been updated.")}),g(!1),v(null),n.reset()},onError:s=>{u({title:t("pets.error.update","Failed to update pet"),description:s.message,variant:"destructive"})}}),te=L({mutationFn:async s=>await(await H("DELETE",`/api/pets/${s}`,{})).json(),onSuccess:()=>{O.invalidateQueries({queryKey:["/api/users",a==null?void 0:a.id,"pets"]}),u({title:t("pets.success.delete","Pet removed"),description:t("pets.success.delete_desc","Your pet has been removed from your profile.")}),P(null)},onError:s=>{u({title:t("pets.error.delete","Failed to delete pet"),description:s.message,variant:"destructive"})}}),ae=s=>{b?T.mutate({id:b.id,data:s}):A.mutate(s)},ie=s=>{v(s),_(s.species);let i="";if(s.lastVisitDate)try{const l=new Date(s.lastVisitDate);isNaN(l.getTime())||(i=l.toISOString().split("T")[0])}catch(l){console.error("Error formatting date:",l)}n.reset({name:s.name,species:s.species,breed:s.breed||"",age:s.age?Number(s.age):void 0,weight:s.weight?Number(s.weight):void 0,medicalNotes:s.medicalNotes||"",lastVisitHospitalId:s.lastVisitHospitalId||"",lastVisitDate:i}),g(!0)},ne=s=>{P(s)},$=()=>{v(null),_(""),ee("select"),n.reset(),g(!0)},E=V&&!V.email&&!V.phone;return d.useEffect(()=>{!N&&!I&&(a?E&&C("/profile"):C("/"))},[a,N,I,E,C]),N||I?e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center",children:e.jsx("div",{className:"text-gray-600 dark:text-gray-400",children:t("loading.pets","Loading...")})}):!a||E?null:e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 py-8",children:e.jsxs("div",{className:"max-w-4xl mx-auto px-4",children:[e.jsx("div",{className:"mb-6 flex items-center justify-between",children:e.jsx(pe,{href:"/profile",children:e.jsxs(o,{variant:"ghost",size:"sm","data-testid":"button-back",children:[e.jsx(Ze,{className:"w-4 h-4 mr-2"}),t("pets.back_to_profile","Back to Profile")]})})}),e.jsxs(z,{className:"mb-6",children:[e.jsxs(B,{className:"flex flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(K,{className:"flex items-center gap-2",children:[e.jsx(G,{className:"w-6 h-6"}),t("pets.title","My Pets")]}),e.jsx(Q,{children:t("pets.desc","Manage your pets for faster emergency requests")})]}),e.jsxs(Fe,{open:X,onOpenChange:g,children:[e.jsx(He,{asChild:!0,children:e.jsxs(o,{onClick:$,"data-testid":"button-add-pet",children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),t("pets.add","Add Pet")]})}),e.jsxs(Oe,{children:[e.jsx(Le,{children:e.jsx(qe,{children:b?t("pets.edit","Edit Pet"):t("pets.add_new","Add New Pet")})}),e.jsx(me,{...n,children:e.jsxs("form",{onSubmit:n.handleSubmit(ae),className:"space-y-4",children:[e.jsx(c,{control:n.control,name:"name",render:({field:s})=>e.jsxs(p,{children:[e.jsx(m,{children:t("pets.name","Name")}),e.jsx(x,{children:e.jsx(w,{...s,placeholder:t("pets.name_placeholder","Fluffy"),"data-testid":"input-pet-name"})}),e.jsx(h,{})]})}),e.jsx(c,{control:n.control,name:"species",render:({field:s})=>e.jsxs(p,{children:[e.jsx(m,{children:t("pets.species","Species")}),e.jsxs(xe,{onValueChange:s.onChange,value:s.value,children:[e.jsx(x,{children:e.jsx(he,{"data-testid":"select-pet-species",children:e.jsx(ue,{placeholder:t("pets.select_species","Select species")})})}),e.jsx(ge,{children:Object.entries(Re).map(([i,l])=>e.jsx(je,{value:i,"data-testid":`species-${i}`,children:f==="en"?l.en:l.zh},i))})]}),e.jsx(h,{})]})}),e.jsx(c,{control:n.control,name:"breed",render:({field:s})=>e.jsxs(p,{children:[e.jsx(m,{children:t("pets.breed","Breed (Optional)")}),e.jsx(x,{children:e.jsx(Ce,{species:D,value:s.value||"",onChange:s.onChange,placeholder:t("pets.select_breed","Select or type breed..."),testId:"combobox-pet-breed"})}),e.jsx(fe,{className:"text-xs text-muted-foreground",children:f==="en"?"ðŸ’¡ Can't find your pet's breed? No worries! Just type it in and press Enter.":"ðŸ’¡ æ‰¾ä¸åˆ°å“ç¨®ï¼Ÿæ²’é—œä¿‚ï¼ç›´æŽ¥è¼¸å…¥ç„¶å¾ŒæŒ‰Enterå³å¯ã€‚"}),e.jsx(h,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(c,{control:n.control,name:"age",render:({field:s})=>e.jsxs(p,{children:[e.jsx(m,{children:t("pets.age","Age (Optional)")}),e.jsx(x,{children:e.jsx(w,{...s,type:"number",placeholder:t("pets.age_placeholder","3"),"data-testid":"input-pet-age"})}),e.jsx(h,{})]})}),e.jsx(c,{control:n.control,name:"weight",render:({field:s})=>e.jsxs(p,{children:[e.jsx(m,{children:t("pets.weight","Weight (kg, Optional)")}),e.jsx(x,{children:e.jsx(w,{...s,type:"number",step:"0.1",placeholder:t("pets.weight_placeholder","10.5"),"data-testid":"input-pet-weight"})}),e.jsx(h,{})]})})]}),e.jsx(c,{control:n.control,name:"medicalNotes",render:({field:s})=>e.jsxs(p,{children:[e.jsx(m,{children:t("pets.medical_notes","Medical Notes (Optional)")}),e.jsx(x,{children:e.jsx(Ne,{...s,placeholder:t("pets.medical_notes_placeholder","Allergies, medications, conditions..."),rows:3,"data-testid":"textarea-pet-medical-notes"})}),e.jsx(h,{})]})}),e.jsx(c,{control:n.control,name:"lastVisitHospitalId",render:({field:s})=>{var i,l;return e.jsxs(p,{className:"flex flex-col",children:[e.jsx(m,{children:t("pets.last_visit_clinic","Last Visit Clinic (Optional)")}),e.jsxs(Se,{open:U,onOpenChange:q,children:[e.jsx(Pe,{asChild:!0,children:e.jsx(x,{children:e.jsxs(o,{variant:"outline",role:"combobox",className:Y("w-full justify-between",!s.value&&"text-muted-foreground"),"data-testid":"button-select-clinic",children:[s.value?((i=k.find(r=>r.id===s.value))==null?void 0:i[f==="en"?"name":"nameZh"])||((l=k.find(r=>r.id===s.value))==null?void 0:l.name):t("pets.last_visit_clinic_placeholder","Search clinic..."),e.jsx(De,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})})}),e.jsx(_e,{className:"w-[400px] p-0",children:e.jsxs(Ve,{children:[e.jsx(Ie,{placeholder:t("pets.last_visit_clinic_placeholder","Search clinic...")}),e.jsxs(ke,{children:[e.jsx(Ae,{children:t("pets.no_clinic_selected","No clinic selected")}),e.jsx(Te,{children:k.map(r=>e.jsxs(Ee,{value:r.name,onSelect:()=>{n.setValue("lastVisitHospitalId",r.id),q(!1)},"data-testid":`clinic-${r.id}`,children:[e.jsx(be,{className:Y("mr-2 h-4 w-4",r.id===s.value?"opacity-100":"opacity-0")}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:f==="en"?r.name:r.nameZh||r.name}),e.jsx("div",{className:"text-sm text-gray-500",children:f==="en"?r.address:r.addressZh||r.address})]})]},r.id))})]})]})})]}),e.jsx(h,{})]})}}),e.jsx(c,{control:n.control,name:"lastVisitDate",render:({field:s})=>e.jsxs(p,{children:[e.jsx(m,{children:t("pets.last_visit_date","Last Visit Date (Optional)")}),e.jsx(x,{children:e.jsx(w,{...s,type:"date","data-testid":"input-last-visit-date"})}),e.jsx(h,{})]})}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(o,{type:"button",variant:"outline",onClick:()=>{g(!1),v(null),n.reset()},"data-testid":"button-cancel-pet",children:t("button.cancel","Cancel")}),e.jsx(o,{type:"submit",disabled:A.isPending||T.isPending,"data-testid":"button-save-pet",children:A.isPending||T.isPending?t("pets.saving","Saving..."):b?t("pets.update","Update Pet"):t("pets.add","Add Pet")})]})]})})]})]})]}),e.jsx(W,{children:se?e.jsx("div",{className:"text-center py-8 text-gray-500 dark:text-gray-400",children:t("loading.pets","Loading pets...")}):M.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(G,{className:"w-12 h-12 mx-auto mb-4 text-gray-300 dark:text-gray-600"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mb-4",children:t("pets.no_pets","No pets added yet")}),e.jsxs(o,{onClick:$,"data-testid":"button-add-first-pet",children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),t("pets.add_first","Add Your First Pet")]})]}):e.jsx("div",{className:"grid gap-4 md:grid-cols-2",children:M.map(s=>e.jsxs(z,{"data-testid":`card-pet-${s.id}`,children:[e.jsxs(B,{children:[e.jsxs(K,{className:"flex items-center justify-between",children:[e.jsx("span",{children:s.name}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(o,{variant:"ghost",size:"sm",onClick:()=>ie(s),"data-testid":`button-edit-pet-${s.id}`,children:e.jsx(Ge,{className:"w-4 h-4"})}),e.jsx(o,{variant:"ghost",size:"sm",onClick:()=>ne(s.id),"data-testid":`button-delete-pet-${s.id}`,children:e.jsx(Je,{className:"w-4 h-4 text-red-500 dark:text-red-400"})})]})]}),e.jsxs(Q,{children:[s.species,s.breed&&` â€¢ ${s.breed}`]})]}),e.jsx(W,{children:e.jsxs("div",{className:"text-sm text-gray-600 dark:text-gray-400 space-y-1",children:[s.age&&e.jsx("div",{children:t("pets.age_years","Age: {age} years").replace("{age}",String(s.age))}),s.weight&&e.jsx("div",{children:t("pets.weight_kg","Weight: {weight} kg").replace("{weight}",String(s.weight))}),s.medicalNotes&&e.jsxs("div",{className:"mt-2 p-2 bg-yellow-50 dark:bg-yellow-900/20 rounded text-yellow-800 dark:text-yellow-200",children:[e.jsx("strong",{children:t("pets.medical_label","Medical:")})," ",s.medicalNotes]})]})})]},s.id))})})]}),e.jsx(Me,{open:!!S,onOpenChange:()=>P(null),children:e.jsxs($e,{children:[e.jsxs(ze,{children:[e.jsx(Be,{children:t("pets.delete","Delete Pet")}),e.jsx(Ke,{children:t("pets.delete_confirm","Are you sure you want to remove this pet from your profile? This action cannot be undone.")})]}),e.jsxs(Qe,{children:[e.jsx(Ye,{"data-testid":"button-cancel-delete",children:t("button.cancel","Cancel")}),e.jsx(We,{onClick:()=>S&&te.mutate(S),className:"bg-red-500 hover:bg-red-600 dark:bg-red-600 dark:hover:bg-red-700","data-testid":"button-confirm-delete",children:t("button.delete","Delete")})]})]})})]})})}export{xs as default};
