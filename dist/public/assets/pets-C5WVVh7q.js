import{c as Pe,ai as rs,r as c,j as e,aj as ke,ak as A,u as ce,B as y,L as Se,a9 as Ce,d as De,al as oe,T as _,a as ze,h as ie,Y as re,$ as Te,am as He,a0 as _e,a1 as Ke,a2 as $e,I as ee,J as Re,K as Ee,N as Le,O as Me,P as Fe,U as q,e as is,f as ns,g as ls,S as os,X as ds,C as he,v as me,w as xe,y as ge,F as cs,z as F,A as I,D as V,E as O,G as U,H as ps,b as je,o as us,s as J,an as fe,ah as hs,V as ms}from"./index-yGPiJpIr.js";import{u as B}from"./useMutation-g6oReyS0.js";import{T as xs}from"./textarea-B-COFCfx.js";import{B as gs,P as js,a as fs,C as vs,b as bs,c as ys,d as ws,e as Ns,f as Ps,g as ks,h as Ss}from"./BreedCombobox-3ClCF4Op.js";import{A as Ie,a as Ve,b as Oe,c as Ue,d as Ae,e as qe,f as Be,g as Ze}from"./alert-dialog-CbtaLizn.js";import{U as de,C as Qe,u as We}from"./useStorageStatus-CWBDob1J.js";import{S as Cs}from"./switch-BdZ2xI1R.js";import{A as Ds,a as zs,b as Ts,c as Hs}from"./accordion-5sL8WrAM.js";import{F as ve}from"./file-text-CJoYtlB-.js";import{S as _s}from"./shield-CCzToWzY.js";import{D as Ks}from"./download-CBUc3OPD.js";import{T as Ye}from"./trash-2-pXZASDYN.js";import{A as $s}from"./arrow-left-BVTF3Tl5.js";import{P as le}from"./paw-print-D6Tii1Io.js";import{P as be}from"./plus-oXMKgXWF.js";import{P as Rs}from"./pencil-TrFe8HXS.js";import"./search-DPDD1EGd.js";import"./index-C-LwW-wl.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Es=Pe("FileImage",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["circle",{cx:"10",cy:"12",r:"2",key:"737tya"}],["path",{d:"m20 17-1.296-1.296a2.41 2.41 0 0 0-3.408 0L9 22",key:"wt3hpn"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ls=Pe("File",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}]]),Ms={dog:{en:"Dog",zh:"ç‹—"},cat:{en:"Cat",zh:"è²“"}};var pe="Progress",ue=100,[Fs,jt]=rs(pe),[Is,Vs]=Fs(pe),Xe=c.forwardRef((a,o)=>{const{__scopeProgress:m,value:d=null,max:t,getValueLabel:k=Os,...j}=a;(t||t===0)&&!ye(t)&&console.error(Us(`${t}`,"Progress"));const f=ye(t)?t:ue;d!==null&&!we(d,f)&&console.error(As(`${d}`,"Progress"));const b=we(d,f)?d:null,v=ne(b)?k(b,f):void 0;return e.jsx(Is,{scope:m,value:b,max:f,children:e.jsx(ke.div,{"aria-valuemax":f,"aria-valuemin":0,"aria-valuenow":ne(b)?b:void 0,"aria-valuetext":v,role:"progressbar","data-state":es(b,f),"data-value":b??void 0,"data-max":f,...j,ref:o})})});Xe.displayName=pe;var Ge="ProgressIndicator",Je=c.forwardRef((a,o)=>{const{__scopeProgress:m,...d}=a,t=Vs(Ge,m);return e.jsx(ke.div,{"data-state":es(t.value,t.max),"data-value":t.value??void 0,"data-max":t.max,...d,ref:o})});Je.displayName=Ge;function Os(a,o){return`${Math.round(a/o*100)}%`}function es(a,o){return a==null?"indeterminate":a===o?"complete":"loading"}function ne(a){return typeof a=="number"}function ye(a){return ne(a)&&!isNaN(a)&&a>0}function we(a,o){return ne(a)&&!isNaN(a)&&a<=o&&a>=0}function Us(a,o){return`Invalid prop \`max\` of value \`${a}\` supplied to \`${o}\`. Only numbers greater than 0 are valid max values. Defaulting to \`${ue}\`.`}function As(a,o){return`Invalid prop \`value\` of value \`${a}\` supplied to \`${o}\`. The \`value\` prop must be:
  - a positive number
  - less than the value passed to \`max\` (or ${ue} if no \`max\` prop is set)
  - \`null\` or \`undefined\` if the progress is indeterminate.

Defaulting to \`null\`.`}var ss=Xe,qs=Je;const ts=c.forwardRef(({className:a,value:o,...m},d)=>e.jsx(ss,{ref:d,className:A("relative h-4 w-full overflow-hidden rounded-full bg-secondary",a),...m,children:e.jsx(qs,{className:"h-full w-full flex-1 bg-primary transition-all",style:{transform:`translateX(-${100-(o||0)}%)`}})}));ts.displayName=ss.displayName;const Bs=a=>a<1024?`${a} B`:a<1024*1024?`${(a/1024).toFixed(1)} KB`:`${(a/(1024*1024)).toFixed(1)} MB`,Zs=()=>Math.random().toString(36).substring(2,11);function Qs({onUploadComplete:a,onError:o,maxFileSize:m=10485760,allowedTypes:d=["image/*","application/pdf"],disabled:t=!1,multiple:k=!1}){const{language:j}=ce(),[f,b]=c.useState(!1),[v,p]=c.useState([]),N=c.useRef(null),z=c.useRef(null),S=c.useRef(0),P=c.useRef([]);c.useEffect(()=>()=>{P.current.forEach(r=>{URL.revokeObjectURL(r)}),P.current=[]},[]);const T=c.useCallback(r=>d.some(i=>{if(i.endsWith("/*")){const l=i.replace("/*","/");return r.type.startsWith(l)}return r.type===i}),[d]),se=c.useCallback(r=>{if(r.size>m){const i=(m/1048576).toFixed(0);return j==="zh-HK"?`æ–‡ä»¶éŽå¤§ï¼Œæœ€å¤§å…è¨± ${i}MB`:`File too large, max ${i}MB allowed`}return T(r)?null:j==="zh-HK"?"ä¸æ”¯æ´çš„æ–‡ä»¶æ ¼å¼":"Unsupported file format"},[m,T,j]),L=async r=>{const{file:i,id:l}=r;p(x=>x.map(w=>w.id===l?{...w,status:"uploading",progress:0}:w));try{const x=await _("POST","/api/medical-records/upload-url"),{uploadURL:w}=await x.json();await new Promise((E,M)=>{const D=new XMLHttpRequest;D.withCredentials=!0,D.upload.addEventListener("progress",G=>{if(G.lengthComputable){const ae=Math.round(G.loaded/G.total*100);p(s=>s.map(n=>n.id===l?{...n,progress:ae}:n))}}),D.onload=()=>{D.status>=200&&D.status<300?E():M(new Error(`Upload failed: ${D.status}`))},D.onerror=()=>M(new Error("Network error")),D.open("PUT",w),D.setRequestHeader("Content-Type",i.type),D.send(i)});const H=w.split("?")[0];p(E=>E.map(M=>M.id===l?{...M,status:"success",progress:100,uploadedUrl:H}:M)),a({url:H,size:i.size,type:i.type})}catch(x){console.error("Upload error:",x);const w=j==="zh-HK"?"ä¸Šå‚³å¤±æ•—ï¼Œè«‹é‡è©¦":"Upload failed, please try again";p(H=>H.map(E=>E.id===l?{...E,status:"error",error:w}:E)),o==null||o(w)}},Z=async r=>{const i=[];for(const l of Array.from(r)){const x=se(l);if(x){o==null||o(x);continue}const w=Zs();let H=null;if(l.type.startsWith("image/")&&(H=URL.createObjectURL(l),P.current.push(H)),i.push({id:w,file:l,previewUrl:H,progress:0,status:"pending"}),!k)break}if(i.length!==0){p(k?l=>[...l,...i]:l=>(l.forEach(x=>{x.previewUrl&&(URL.revokeObjectURL(x.previewUrl),P.current=P.current.filter(w=>w!==x.previewUrl))}),i));for(const l of i)await L(l)}},te=r=>{r.preventDefault(),r.stopPropagation(),S.current++,r.dataTransfer.items&&r.dataTransfer.items.length>0&&b(!0)},Q=r=>{r.preventDefault(),r.stopPropagation(),S.current--,S.current===0&&b(!1)},K=r=>{r.preventDefault(),r.stopPropagation()},$=r=>{if(r.preventDefault(),r.stopPropagation(),b(!1),S.current=0,t)return;const i=r.dataTransfer.files;i&&i.length>0&&Z(i)},X=r=>{const i=r.target.files;i&&i.length>0&&Z(i),r.target.value=""},W=r=>{p(i=>{const l=i.find(x=>x.id===r);return l!=null&&l.previewUrl&&(URL.revokeObjectURL(l.previewUrl),P.current=P.current.filter(x=>x!==l.previewUrl)),i.filter(x=>x.id!==r)})},h=d.map(r=>r==="application/pdf"?".pdf":(r.startsWith("image/"),r)).join(","),R=v.some(r=>r.status==="uploading"),C=t||R,Y=r=>r.type.startsWith("image/")?e.jsx(Es,{className:"w-6 h-6 text-blue-500"}):e.jsx(Ls,{className:"w-6 h-6 text-gray-500 dark:text-gray-400"});return e.jsxs("div",{className:"space-y-3",children:[e.jsx("input",{ref:N,type:"file",accept:h,onChange:X,className:"hidden",disabled:C,multiple:k,"data-testid":"input-file-drop"}),e.jsx("input",{ref:z,type:"file",accept:"image/*",capture:"environment",onChange:X,className:"hidden",disabled:C,"data-testid":"input-camera-drop"}),v.length===0&&e.jsx("div",{className:A("relative border-2 border-dashed rounded-lg p-6 transition-all duration-200 cursor-pointer","bg-gray-50 dark:bg-gray-800/50",f?"border-blue-500 bg-blue-50 dark:bg-blue-900/20":"border-gray-300 dark:border-gray-600 hover:border-gray-400 dark:hover:border-gray-500",C&&"opacity-50 cursor-not-allowed"),onDragEnter:te,onDragLeave:Q,onDragOver:K,onDrop:$,onClick:()=>{var r;return!C&&((r=N.current)==null?void 0:r.click())},"data-testid":"dropzone-area",children:e.jsxs("div",{className:"flex flex-col items-center justify-center text-center",children:[e.jsx("div",{className:A("w-12 h-12 rounded-full flex items-center justify-center mb-3",f?"bg-blue-100 dark:bg-blue-900/40":"bg-gray-100 dark:bg-gray-700"),children:e.jsx(de,{className:A("w-6 h-6",f?"text-blue-500":"text-gray-400 dark:text-gray-500")})}),e.jsx("p",{className:A("text-sm font-medium mb-1",f?"text-blue-600 dark:text-blue-400":"text-gray-700 dark:text-gray-300"),children:f?j==="zh-HK"?"æ”¾é–‹ä»¥ä¸Šå‚³æ–‡ä»¶":"Drop to upload":j==="zh-HK"?"æ‹–æ”¾æ–‡ä»¶åˆ°æ­¤è™•æˆ–é»žæ“Šé¸æ“‡":"Drag & drop files here or click to select"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:j==="zh-HK"?`æ”¯æ´åœ–ç‰‡å’ŒPDFï¼Œæœ€å¤§ ${(m/(1024*1024)).toFixed(0)}MB`:`Images and PDFs, max ${(m/(1024*1024)).toFixed(0)}MB`})]})}),v.length===0&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(y,{type:"button",variant:"outline",size:"sm",onClick:()=>{var r;return(r=N.current)==null?void 0:r.click()},disabled:C,className:"flex-1","data-testid":"button-browse-files",children:[e.jsx(de,{className:"w-4 h-4 mr-2"}),j==="zh-HK"?"é¸æ“‡æ–‡ä»¶":"Browse Files"]}),e.jsxs(y,{type:"button",variant:"outline",size:"sm",onClick:()=>{var r;return(r=z.current)==null?void 0:r.click()},disabled:C,className:"flex-1","data-testid":"button-take-photo-drop",children:[e.jsx(Qe,{className:"w-4 h-4 mr-2"}),j==="zh-HK"?"æ‹ç…§":"Take Photo"]})]}),v.length>0&&e.jsxs("div",{className:"space-y-2",children:[v.map(r=>e.jsxs("div",{className:A("flex items-start gap-3 p-3 rounded-lg border transition-colors",r.status==="error"?"border-red-200 bg-red-50 dark:border-red-900 dark:bg-red-950/20":r.status==="success"?"border-green-200 bg-green-50 dark:border-green-900 dark:bg-green-950/20":"border-gray-200 bg-gray-50 dark:border-gray-700 dark:bg-gray-800"),"data-testid":`file-item-${r.id}`,children:[r.previewUrl?e.jsx("img",{src:r.previewUrl,alt:r.file.name,className:"w-14 h-14 object-cover rounded-md flex-shrink-0"}):e.jsx("div",{className:"w-14 h-14 flex items-center justify-center bg-gray-100 dark:bg-gray-700 rounded-md flex-shrink-0",children:Y(r.file)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 dark:text-gray-100 truncate",children:r.file.name}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:Bs(r.file.size)})]}),e.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0",children:[r.status==="uploading"&&e.jsx(Se,{className:"w-4 h-4 animate-spin text-blue-500"}),r.status==="success"&&e.jsx(Ce,{className:"w-4 h-4 text-green-500"}),r.status==="error"&&e.jsx(De,{className:"w-4 h-4 text-red-500"}),r.status!=="uploading"&&e.jsx(y,{type:"button",variant:"ghost",size:"sm",onClick:()=>W(r.id),className:"h-7 w-7 p-0","data-testid":`button-remove-file-${r.id}`,children:e.jsx(oe,{className:"w-4 h-4"})})]})]}),r.status==="uploading"&&e.jsxs("div",{className:"mt-2",children:[e.jsx(ts,{value:r.progress,className:"h-1.5"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:j==="zh-HK"?`ä¸Šå‚³ä¸­ ${r.progress}%`:`Uploading ${r.progress}%`})]}),r.status==="success"&&e.jsx("p",{className:"text-xs text-green-600 dark:text-green-400 mt-1",children:j==="zh-HK"?"ä¸Šå‚³æˆåŠŸ":"Upload complete"}),r.status==="error"&&e.jsx("p",{className:"text-xs text-red-600 dark:text-red-400 mt-1",children:r.error})]})]},r.id)),!R&&e.jsxs(y,{type:"button",variant:"outline",size:"sm",onClick:()=>{v.forEach(r=>{r.previewUrl&&URL.revokeObjectURL(r.previewUrl)}),P.current=[],p([])},className:"w-full","data-testid":"button-clear-all-files",children:[e.jsx(oe,{className:"w-4 h-4 mr-2"}),j==="zh-HK"?"æ¸…é™¤æ‰€æœ‰æ–‡ä»¶":"Clear All"]})]})]})}const Ne=[{value:"blood_test",labelEn:"Blood Test",labelZh:"è¡€æ¶²æª¢æŸ¥"},{value:"xray",labelEn:"X-Ray",labelZh:"Xå…‰"},{value:"vaccination",labelEn:"Vaccination Record",labelZh:"ç–«è‹—è¨˜éŒ„"},{value:"surgery_report",labelEn:"Surgery Report",labelZh:"æ‰‹è¡“å ±å‘Š"},{value:"prescription",labelEn:"Prescription",labelZh:"è™•æ–¹"},{value:"other",labelEn:"Other Document",labelZh:"å…¶ä»–æ–‡ä»¶"}];function Ws({petId:a,petName:o}){const{toast:m}=ze(),{t:d,language:t}=ce(),{isStorageAvailable:k}=We(),[j,f]=c.useState(!1),[b,v]=c.useState(null),[p,N]=c.useState({title:"",documentType:"other",description:""}),[z,S]=c.useState(null),[P,T]=c.useState(0),[se,L]=c.useState(""),{data:Z=[],isLoading:te}=ie({queryKey:["/api/pets",a,"medical-records"]}),{data:Q=[]}=ie({queryKey:["/api/pets",a,"medical-consents"]}),K=Q.find(i=>i.consentType==="emergency_broadcast"),$=B({mutationFn:async i=>await(await _("POST","/api/medical-records",i)).json(),onSuccess:()=>{q.invalidateQueries({queryKey:["/api/pets",a,"medical-records"]}),f(!1),N({title:"",documentType:"other",description:""}),S(null),T(0),L(""),m({title:t==="zh-HK"?"è¨˜éŒ„å·²ä¸Šå‚³":"Record Uploaded",description:t==="zh-HK"?"é†«ç™‚è¨˜éŒ„å·²æˆåŠŸå„²å­˜":"Medical record saved successfully"})},onError:i=>{m({title:t==="zh-HK"?"ä¸Šå‚³å¤±æ•—":"Upload Failed",description:i.message,variant:"destructive"})}}),X=B({mutationFn:async i=>{await _("DELETE",`/api/medical-records/${i}`)},onSuccess:()=>{q.invalidateQueries({queryKey:["/api/pets",a,"medical-records"]}),v(null),m({title:t==="zh-HK"?"è¨˜éŒ„å·²åˆªé™¤":"Record Deleted"})}}),W=B({mutationFn:async i=>await(await _("PUT",`/api/pets/${a}/medical-consents`,i)).json(),onSuccess:()=>{q.invalidateQueries({queryKey:["/api/pets",a,"medical-consents"]}),m({title:t==="zh-HK"?"è¨­å®šå·²æ›´æ–°":"Settings Updated"})}}),h=i=>{S(i.url),T(i.size),L(i.type)},R=i=>{m({title:t==="zh-HK"?"ä¸Šå‚³å¤±æ•—":"Upload Failed",description:i,variant:"destructive"})},C=()=>{if(!z||!p.title){m({title:t==="zh-HK"?"è«‹å¡«å¯«å¿…è¦è³‡æ–™":"Please fill required fields",description:t==="zh-HK"?"éœ€è¦æ¨™é¡Œå’Œæ–‡ä»¶":"Title and file are required",variant:"destructive"});return}$.mutate({petId:a,title:p.title,documentType:p.documentType,description:p.description,filePath:z,fileSize:P,mimeType:se,isConfidential:!1})},Y=i=>{const l=Ne.find(x=>x.value===i);return l?t==="zh-HK"?l.labelZh:l.labelEn:i},r=i=>i<1024?`${i} B`:i<1024*1024?`${(i/1024).toFixed(1)} KB`:`${(i/(1024*1024)).toFixed(1)} MB`;return e.jsxs(Ds,{type:"single",collapsible:!0,className:"mt-4",children:[e.jsxs(zs,{value:"medical-records",className:"border rounded-lg",children:[e.jsx(Ts,{className:"px-4 hover:no-underline","data-testid":`accordion-medical-records-${a}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ve,{className:"w-4 h-4"}),e.jsx("span",{children:t==="zh-HK"?"é†«ç™‚è¨˜éŒ„":"Medical Records"}),e.jsxs("span",{className:"text-sm text-gray-500",children:["(",Z.length,")"]})]})}),e.jsxs(Hs,{className:"px-4 pb-4",children:[e.jsxs("div",{className:"mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_s,{className:"w-4 h-4 text-blue-600 dark:text-blue-400"}),e.jsx(re,{htmlFor:`consent-${a}`,className:"text-sm font-medium",children:t==="zh-HK"?"ç·Šæ€¥æƒ…æ³æ™‚åˆ†äº«é†«ç™‚è¨˜éŒ„":"Share records during emergencies"})]}),e.jsx(Cs,{id:`consent-${a}`,checked:(K==null?void 0:K.enabled)??!1,onCheckedChange:i=>{W.mutate({consentType:"emergency_broadcast",enabled:i})},"data-testid":`switch-emergency-consent-${a}`})]}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400 mt-1",children:t==="zh-HK"?"å•Ÿç”¨å¾Œï¼Œæ‚¨çš„å¯µç‰©é†«ç™‚è¨˜éŒ„æœƒåœ¨ç·Šæ€¥å»£æ’­æ™‚è‡ªå‹•åˆ†äº«çµ¦é†«é™¢":"When enabled, medical records will be shared with hospitals during emergency broadcasts"})]}),k?e.jsxs(Te,{open:j,onOpenChange:f,children:[e.jsx(He,{asChild:!0,children:e.jsxs(y,{variant:"outline",size:"sm",className:"mb-4","data-testid":`button-upload-record-${a}`,children:[e.jsx(de,{className:"w-4 h-4 mr-2"}),t==="zh-HK"?"ä¸Šå‚³è¨˜éŒ„":"Upload Record"]})}),e.jsxs(_e,{children:[e.jsx(Ke,{children:e.jsx($e,{children:t==="zh-HK"?`ä¸Šå‚³ ${o} çš„é†«ç™‚è¨˜éŒ„`:`Upload Medical Record for ${o}`})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs(re,{children:[t==="zh-HK"?"æ¨™é¡Œ":"Title"," *"]}),e.jsx(ee,{value:p.title,onChange:i=>N({...p,title:i.target.value}),placeholder:t==="zh-HK"?"ä¾‹å¦‚ï¼š2024å¹´12æœˆè¡€æ¶²æª¢æŸ¥":"e.g., Blood Test Dec 2024","data-testid":"input-record-title"})]}),e.jsxs("div",{children:[e.jsx(re,{children:t==="zh-HK"?"æ–‡ä»¶é¡žåž‹":"Document Type"}),e.jsxs(Re,{value:p.documentType,onValueChange:i=>N({...p,documentType:i}),children:[e.jsx(Ee,{"data-testid":"select-document-type",children:e.jsx(Le,{})}),e.jsx(Me,{children:Ne.map(i=>e.jsx(Fe,{value:i.value,children:t==="zh-HK"?i.labelZh:i.labelEn},i.value))})]})]}),e.jsxs("div",{children:[e.jsx(re,{children:t==="zh-HK"?"å‚™è¨»ï¼ˆé¸å¡«ï¼‰":"Notes (Optional)"}),e.jsx(ee,{value:p.description,onChange:i=>N({...p,description:i.target.value}),placeholder:t==="zh-HK"?"ä»»ä½•é¡å¤–èªªæ˜Ž...":"Any additional notes...","data-testid":"input-record-description"})]}),e.jsxs("div",{children:[e.jsxs(re,{children:[t==="zh-HK"?"æ–‡ä»¶":"File"," *"]}),e.jsx("div",{className:"mt-2",children:e.jsx(Qs,{onUploadComplete:h,onError:R,maxFileSize:10485760,allowedTypes:["image/*","application/pdf"],disabled:$.isPending},j?"open":"closed")})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(y,{variant:"outline",onClick:()=>{f(!1),N({title:"",documentType:"other",description:""}),S(null),T(0),L("")},children:t==="zh-HK"?"å–æ¶ˆ":"Cancel"}),e.jsx(y,{onClick:C,disabled:$.isPending||!z||!p.title,"data-testid":"button-save-record",children:$.isPending?t==="zh-HK"?"å„²å­˜ä¸­...":"Saving...":t==="zh-HK"?"å„²å­˜è¨˜éŒ„":"Save Record"})]})]})]})]}):e.jsxs("div",{className:"mb-4 p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg flex items-center gap-2",children:[e.jsx(De,{className:"w-4 h-4 text-yellow-600 dark:text-yellow-400"}),e.jsx("p",{className:"text-sm text-yellow-700 dark:text-yellow-300",children:t==="zh-HK"?"æª”æ¡ˆä¸Šå‚³åŠŸèƒ½æš«æ™‚æœªèƒ½ä½¿ç”¨":"File upload is currently unavailable"})]}),te?e.jsx("div",{className:"text-center py-4 text-gray-500",children:t==="zh-HK"?"è¼‰å…¥ä¸­...":"Loading..."}):Z.length===0?e.jsxs("div",{className:"text-center py-4 text-gray-500",children:[e.jsx(ve,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:t==="zh-HK"?"å°šç„¡é†«ç™‚è¨˜éŒ„":"No medical records yet"})]}):e.jsx("div",{className:"space-y-2",children:Z.map(i=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg","data-testid":`record-item-${i.id}`,children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium truncate",children:i.title}),e.jsxs("div",{className:"text-xs text-gray-500 flex items-center gap-2",children:[e.jsx("span",{children:Y(i.documentType)}),e.jsx("span",{children:"â€¢"}),e.jsx("span",{children:r(i.fileSize)}),e.jsx("span",{children:"â€¢"}),e.jsx("span",{children:new Date(i.uploadedAt).toLocaleDateString()})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(y,{variant:"ghost",size:"sm",onClick:()=>window.open(i.filePath,"_blank"),"data-testid":`button-download-record-${i.id}`,children:e.jsx(Ks,{className:"w-4 h-4"})}),e.jsx(y,{variant:"ghost",size:"sm",onClick:()=>v(i.id),"data-testid":`button-delete-record-${i.id}`,children:e.jsx(Ye,{className:"w-4 h-4 text-red-500"})})]})]},i.id))})]})]}),e.jsx(Ie,{open:!!b,onOpenChange:()=>v(null),children:e.jsxs(Ve,{children:[e.jsxs(Oe,{children:[e.jsx(Ue,{children:t==="zh-HK"?"åˆªé™¤è¨˜éŒ„":"Delete Record"}),e.jsx(Ae,{children:t==="zh-HK"?"ç¢ºå®šè¦åˆªé™¤é€™ä»½é†«ç™‚è¨˜éŒ„å—Žï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚":"Are you sure you want to delete this medical record? This action cannot be undone."})]}),e.jsxs(qe,{children:[e.jsx(Be,{children:t==="zh-HK"?"å–æ¶ˆ":"Cancel"}),e.jsx(Ze,{onClick:()=>b&&X.mutate(b),className:"bg-red-500 hover:bg-red-600",children:t==="zh-HK"?"åˆªé™¤":"Delete"})]})]})})]})}const Ys=a=>us({name:J().min(1,a("pets.validation.name_required","Pet name is required")),species:J().min(1,a("pets.validation.species_required","Species is required")),breed:J().optional(),age:fe.number().positive().optional(),weight:fe.number().positive().optional(),medicalNotes:J().optional(),lastVisitHospitalId:J().optional(),lastVisitDate:J().optional()});function ft(){const{user:a,isLoading:o}=is(),[,m]=ns(),{toast:d}=ze(),{t,language:k}=ce(),{isStorageAvailable:j}=We(),f=Ys(t),[b,v]=c.useState(!1),[p,N]=c.useState(null),[z,S]=c.useState(null),[P,T]=c.useState(""),[se,L]=c.useState(!1),[Z,te]=c.useState("select"),{data:Q,isLoading:K}=ie({queryKey:["/api/users",a==null?void 0:a.id],enabled:!!(a!=null&&a.id)}),{data:$=[],isLoading:X}=ie({queryKey:["/api/users",a==null?void 0:a.id,"pets"],enabled:!!(a!=null&&a.id)}),{data:W=[]}=ie({queryKey:["/api/clinics"]}),h=ls({resolver:hs(f),defaultValues:{name:"",species:"",breed:"",age:void 0,weight:void 0,medicalNotes:"",lastVisitHospitalId:void 0,lastVisitDate:void 0}}),R=h.watch("species");c.useEffect(()=>{R&&R!==P&&(T(R),h.setValue("breed",""))},[R,P,h]);const C=B({mutationFn:async s=>{const n={...s,userId:a==null?void 0:a.id,weight:s.weight!==void 0?String(s.weight):void 0,lastVisitDate:s.lastVisitDate?new Date(s.lastVisitDate).toISOString():void 0,lastVisitHospitalId:s.lastVisitHospitalId&&s.lastVisitHospitalId.trim()!==""?s.lastVisitHospitalId:void 0};return await(await _("POST","/api/pets",n)).json()},onSuccess:(s,n)=>{q.invalidateQueries({queryKey:["/api/users",a==null?void 0:a.id,"pets"]}),ms.trackPetCreation({petType:n.species,breed:n.breed}),d({title:t("pets.success.add","Pet added successfully!"),description:t("pets.success.add_desc","Your pet has been added to your profile.")}),v(!1),h.reset()},onError:s=>{d({title:t("pets.error.add","Failed to add pet"),description:s.message,variant:"destructive"})}}),Y=B({mutationFn:async({id:s,data:n})=>{const u={...n,weight:n.weight!==void 0?String(n.weight):void 0,lastVisitDate:n.lastVisitDate?new Date(n.lastVisitDate).toISOString():void 0,lastVisitHospitalId:n.lastVisitHospitalId&&n.lastVisitHospitalId.trim()!==""?n.lastVisitHospitalId:void 0};return await(await _("PATCH",`/api/pets/${s}`,u)).json()},onSuccess:()=>{q.invalidateQueries({queryKey:["/api/users",a==null?void 0:a.id,"pets"]}),d({title:t("pets.success.update","Pet updated successfully!"),description:t("pets.success.update_desc","Your pet's information has been updated.")}),v(!1),N(null),h.reset()},onError:s=>{d({title:t("pets.error.update","Failed to update pet"),description:s.message,variant:"destructive"})}}),r=B({mutationFn:async s=>await(await _("DELETE",`/api/pets/${s}`,{})).json(),onSuccess:()=>{q.invalidateQueries({queryKey:["/api/users",a==null?void 0:a.id,"pets"]}),d({title:t("pets.success.delete","Pet removed"),description:t("pets.success.delete_desc","Your pet has been removed from your profile.")}),S(null)},onError:s=>{d({title:t("pets.error.delete","Failed to delete pet"),description:s.message,variant:"destructive"})}}),[i,l]=c.useState(null),x=B({mutationFn:async({petId:s,file:n})=>{const u=await _("POST",`/api/pets/${s}/photo-upload-url`,{contentType:n.type}),{uploadURL:g}=await u.json();if(!(await fetch(g,{method:"PUT",headers:{"Content-Type":n.type},body:n})).ok)throw new Error("Failed to upload photo");const as=g.split("?")[0];return await(await _("POST",`/api/pets/${s}/photo`,{filePath:as})).json()},onSuccess:()=>{q.invalidateQueries({queryKey:["/api/users",a==null?void 0:a.id,"pets"]}),d({title:t("pets.success.photo_upload","Photo uploaded!"),description:t("pets.success.photo_upload_desc","Your pet's photo has been updated.")}),l(null)},onError:s=>{let n=s.message;try{const u=JSON.parse(s.message);u.message?n=u.message:u.error&&(n=u.error)}catch{}d({title:t("pets.error.photo_upload","Failed to upload photo"),description:n,variant:"destructive"}),l(null)}}),w=B({mutationFn:async s=>await(await _("DELETE",`/api/pets/${s}/photo`,{})).json(),onSuccess:()=>{q.invalidateQueries({queryKey:["/api/users",a==null?void 0:a.id,"pets"]}),d({title:t("pets.success.photo_delete","Photo removed"),description:t("pets.success.photo_delete_desc","Your pet's photo has been removed.")})},onError:s=>{d({title:t("pets.error.photo_delete","Failed to remove photo"),description:s.message,variant:"destructive"})}}),H=(s,n)=>{var g;const u=(g=n.target.files)==null?void 0:g[0];if(u){if(!u.type.startsWith("image/")){d({title:t("pets.error.invalid_file","Invalid file type"),description:t("pets.error.invalid_file_desc","Please select an image file (JPEG, PNG, etc.)"),variant:"destructive"}),n.target.value="";return}if(u.size>5*1024*1024){d({title:t("pets.error.file_too_large","File too large"),description:t("pets.error.file_too_large_desc","Maximum file size is 5MB"),variant:"destructive"}),n.target.value="";return}l(s),x.mutate({petId:s,file:u})}n.target.value=""},E=s=>{p?Y.mutate({id:p.id,data:s}):C.mutate(s)},M=s=>{N(s),T(s.species);let n="";if(s.lastVisitDate)try{const u=new Date(s.lastVisitDate);isNaN(u.getTime())||(n=u.toISOString().split("T")[0])}catch(u){console.error("Error formatting date:",u)}h.reset({name:s.name,species:s.species,breed:s.breed||"",age:s.age?Number(s.age):void 0,weight:s.weight?Number(s.weight):void 0,medicalNotes:s.medicalNotes||"",lastVisitHospitalId:s.lastVisitHospitalId||"",lastVisitDate:n}),v(!0)},D=s=>{S(s)},G=()=>{N(null),T(""),te("select"),h.reset(),v(!0)},ae=Q&&!Q.email&&!Q.phone;return c.useEffect(()=>{!o&&!K&&(a?ae&&m("/profile"):m("/"))},[a,o,K,ae,m]),o||K?e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center",children:e.jsx("div",{className:"text-gray-600 dark:text-gray-400",children:t("loading.pets","Loading...")})}):!a||ae?null:e.jsxs(e.Fragment,{children:[e.jsx(os,{noindex:!0}),e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 py-8",children:e.jsxs("div",{className:"max-w-4xl mx-auto px-4",children:[e.jsx("div",{className:"mb-6 flex items-center justify-between",children:e.jsx(ds,{href:"/profile",children:e.jsxs(y,{variant:"ghost",size:"sm","data-testid":"button-back",children:[e.jsx($s,{className:"w-4 h-4 mr-2"}),t("pets.back_to_profile","Back to Profile")]})})}),e.jsxs(he,{className:"mb-6",children:[e.jsxs(me,{className:"flex flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(xe,{className:"flex items-center gap-2",children:[e.jsx(le,{className:"w-6 h-6"}),t("pets.title","My Pets")]}),e.jsx(ge,{children:t("pets.desc","Manage your pets for faster emergency requests")})]}),e.jsxs(Te,{open:b,onOpenChange:v,children:[e.jsx(He,{asChild:!0,children:e.jsxs(y,{onClick:G,"data-testid":"button-add-pet",children:[e.jsx(be,{className:"w-4 h-4 mr-2"}),t("pets.add","Add Pet")]})}),e.jsxs(_e,{children:[e.jsx(Ke,{children:e.jsx($e,{children:p?t("pets.edit","Edit Pet"):t("pets.add_new","Add New Pet")})}),e.jsx(cs,{...h,children:e.jsxs("form",{onSubmit:h.handleSubmit(E),className:"space-y-4",children:[e.jsx(F,{control:h.control,name:"name",render:({field:s})=>e.jsxs(I,{children:[e.jsx(V,{children:t("pets.name","Name")}),e.jsx(O,{children:e.jsx(ee,{...s,placeholder:t("pets.name_placeholder","Fluffy"),"data-testid":"input-pet-name"})}),e.jsx(U,{})]})}),e.jsx(F,{control:h.control,name:"species",render:({field:s})=>e.jsxs(I,{children:[e.jsx(V,{children:t("pets.species","Species")}),e.jsxs(Re,{onValueChange:s.onChange,value:s.value,children:[e.jsx(O,{children:e.jsx(Ee,{"data-testid":"select-pet-species",children:e.jsx(Le,{placeholder:t("pets.select_species","Select species")})})}),e.jsx(Me,{children:Object.entries(Ms).map(([n,u])=>e.jsx(Fe,{value:n,"data-testid":`species-${n}`,children:k==="en"?u.en:u.zh},n))})]}),e.jsx(U,{})]})}),e.jsx(F,{control:h.control,name:"breed",render:({field:s})=>e.jsxs(I,{children:[e.jsx(V,{children:t("pets.breed","Breed (Optional)")}),e.jsx(O,{children:e.jsx(gs,{species:P,value:s.value||"",onChange:s.onChange,placeholder:t("pets.select_breed","Select or type breed..."),testId:"combobox-pet-breed"})}),e.jsx(ps,{className:"text-xs text-muted-foreground",children:k==="en"?"ðŸ’¡ Can't find your pet's breed? No worries! Just type it in and press Enter.":"ðŸ’¡ æ‰¾ä¸åˆ°å“ç¨®ï¼Ÿæ²’é—œä¿‚ï¼ç›´æŽ¥è¼¸å…¥ç„¶å¾ŒæŒ‰Enterå³å¯ã€‚"}),e.jsx(U,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(F,{control:h.control,name:"age",render:({field:s})=>e.jsxs(I,{children:[e.jsx(V,{children:t("pets.age","Age (Optional)")}),e.jsx(O,{children:e.jsx(ee,{...s,type:"number",placeholder:t("pets.age_placeholder","3"),"data-testid":"input-pet-age"})}),e.jsx(U,{})]})}),e.jsx(F,{control:h.control,name:"weight",render:({field:s})=>e.jsxs(I,{children:[e.jsx(V,{children:t("pets.weight","Weight (kg, Optional)")}),e.jsx(O,{children:e.jsx(ee,{...s,type:"number",step:"0.1",placeholder:t("pets.weight_placeholder","10.5"),"data-testid":"input-pet-weight"})}),e.jsx(U,{})]})})]}),e.jsx(F,{control:h.control,name:"medicalNotes",render:({field:s})=>e.jsxs(I,{children:[e.jsx(V,{children:t("pets.medical_notes","Medical Notes (Optional)")}),e.jsx(O,{children:e.jsx(xs,{...s,placeholder:t("pets.medical_notes_placeholder","Allergies, medications, conditions..."),rows:3,"data-testid":"textarea-pet-medical-notes"})}),e.jsx(U,{})]})}),e.jsx(F,{control:h.control,name:"lastVisitHospitalId",render:({field:s})=>{var n,u;return e.jsxs(I,{className:"flex flex-col",children:[e.jsx(V,{children:t("pets.last_visit_clinic","Last Visit Clinic (Optional)")}),e.jsxs(js,{open:se,onOpenChange:L,children:[e.jsx(fs,{asChild:!0,children:e.jsx(O,{children:e.jsxs(y,{variant:"outline",role:"combobox",className:A("w-full justify-between",!s.value&&"text-muted-foreground"),"data-testid":"button-select-clinic",children:[s.value?((n=W.find(g=>g.id===s.value))==null?void 0:n[k==="en"?"name":"nameZh"])||((u=W.find(g=>g.id===s.value))==null?void 0:u.name):t("pets.last_visit_clinic_placeholder","Search clinic..."),e.jsx(vs,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})})}),e.jsx(bs,{className:"w-[400px] p-0",children:e.jsxs(ys,{children:[e.jsx(ws,{placeholder:t("pets.last_visit_clinic_placeholder","Search clinic...")}),e.jsxs(Ns,{children:[e.jsx(Ps,{children:t("pets.no_clinic_selected","No clinic selected")}),e.jsx(ks,{children:W.map(g=>e.jsxs(Ss,{value:g.name,onSelect:()=>{h.setValue("lastVisitHospitalId",g.id),L(!1)},"data-testid":`clinic-${g.id}`,children:[e.jsx(Ce,{className:A("mr-2 h-4 w-4",g.id===s.value?"opacity-100":"opacity-0")}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:k==="en"?g.name:g.nameZh||g.name}),e.jsx("div",{className:"text-sm text-gray-500",children:k==="en"?g.address:g.addressZh||g.address})]})]},g.id))})]})]})})]}),e.jsx(U,{})]})}}),e.jsx(F,{control:h.control,name:"lastVisitDate",render:({field:s})=>e.jsxs(I,{children:[e.jsx(V,{children:t("pets.last_visit_date","Last Visit Date (Optional)")}),e.jsx(O,{children:e.jsx(ee,{...s,type:"date","data-testid":"input-last-visit-date"})}),e.jsx(U,{})]})}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(y,{type:"button",variant:"outline",onClick:()=>{v(!1),N(null),h.reset()},"data-testid":"button-cancel-pet",children:t("button.cancel","Cancel")}),e.jsx(y,{type:"submit",disabled:C.isPending||Y.isPending,"data-testid":"button-save-pet",children:C.isPending||Y.isPending?t("pets.saving","Saving..."):p?t("pets.update","Update Pet"):t("pets.add","Add Pet")})]})]})})]})]})]}),e.jsx(je,{children:X?e.jsx("div",{className:"text-center py-8 text-gray-500 dark:text-gray-400",children:t("loading.pets","Loading pets...")}):$.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(le,{className:"w-12 h-12 mx-auto mb-4 text-gray-300 dark:text-gray-600"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mb-4",children:t("pets.no_pets","No pets added yet")}),e.jsxs(y,{onClick:G,"data-testid":"button-add-first-pet",children:[e.jsx(be,{className:"w-4 h-4 mr-2"}),t("pets.add_first","Add Your First Pet")]})]}):e.jsx("div",{className:"grid gap-4 md:grid-cols-2",children:$.map(s=>e.jsxs(he,{"data-testid":`card-pet-${s.id}`,children:[e.jsx(me,{className:"pb-2",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsxs("div",{className:"relative flex-shrink-0",children:[e.jsx("div",{className:"w-20 h-20 rounded-full overflow-hidden bg-gray-100 dark:bg-gray-800 border-2 border-gray-200 dark:border-gray-700",children:s.photoUrl?e.jsx("img",{src:s.photoUrl,alt:s.name,className:"w-full h-full object-cover","data-testid":`img-pet-photo-${s.id}`}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx(le,{className:"w-8 h-8 text-gray-400 dark:text-gray-500"})})}),j&&e.jsxs("label",{className:"absolute bottom-0 right-0 w-7 h-7 bg-primary hover:bg-primary/90 rounded-full flex items-center justify-center cursor-pointer shadow-lg border-2 border-white dark:border-gray-900","data-testid":`button-upload-photo-${s.id}`,children:[i===s.id?e.jsx(Se,{className:"w-4 h-4 text-white animate-spin"}):e.jsx(Qe,{className:"w-4 h-4 text-white"}),e.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:n=>H(s.id,n),disabled:i===s.id,"data-testid":`input-photo-${s.id}`})]}),s.photoUrl&&!i&&e.jsx("button",{className:"absolute top-0 right-0 w-5 h-5 bg-red-500 hover:bg-red-600 rounded-full flex items-center justify-center shadow-sm",onClick:()=>w.mutate(s.id),"data-testid":`button-remove-photo-${s.id}`,children:e.jsx(oe,{className:"w-3 h-3 text-white"})})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs(xe,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"truncate",children:s.name}),e.jsxs("div",{className:"flex gap-1 flex-shrink-0",children:[e.jsx(y,{variant:"ghost",size:"sm",onClick:()=>M(s),"data-testid":`button-edit-pet-${s.id}`,children:e.jsx(Rs,{className:"w-4 h-4"})}),e.jsx(y,{variant:"ghost",size:"sm",onClick:()=>D(s.id),"data-testid":`button-delete-pet-${s.id}`,children:e.jsx(Ye,{className:"w-4 h-4 text-red-500 dark:text-red-400"})})]})]}),e.jsxs(ge,{children:[s.species,s.breed&&` â€¢ ${s.breed}`]})]})]})}),e.jsxs(je,{children:[e.jsxs("div",{className:"text-sm text-gray-600 dark:text-gray-400 space-y-1",children:[s.age&&e.jsx("div",{children:t("pets.age_years","Age: {age} years").replace("{age}",String(s.age))}),s.weight&&e.jsx("div",{children:t("pets.weight_kg","Weight: {weight} kg").replace("{weight}",String(s.weight))}),s.medicalNotes&&e.jsxs("div",{className:"mt-2 p-2 bg-yellow-50 dark:bg-yellow-900/20 rounded text-yellow-800 dark:text-yellow-200",children:[e.jsx("strong",{children:t("pets.medical_label","Medical:")})," ",s.medicalNotes]})]}),e.jsx(Ws,{petId:s.id,petName:s.name})]})]},s.id))})})]}),e.jsx(Ie,{open:!!z,onOpenChange:()=>S(null),children:e.jsxs(Ve,{children:[e.jsxs(Oe,{children:[e.jsx(Ue,{children:t("pets.delete","Delete Pet")}),e.jsx(Ae,{children:t("pets.delete_confirm","Are you sure you want to remove this pet from your profile? This action cannot be undone.")})]}),e.jsxs(qe,{children:[e.jsx(Be,{"data-testid":"button-cancel-delete",children:t("button.cancel","Cancel")}),e.jsx(Ze,{onClick:()=>z&&r.mutate(z),className:"bg-red-500 hover:bg-red-600 dark:bg-red-600 dark:hover:bg-red-700","data-testid":"button-confirm-delete",children:t("button.delete","Delete")})]})]})})]})})]})}export{ft as default};
