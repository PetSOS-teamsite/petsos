import{c as k,a as W,r as E,h as g,j as e,U as P,B as y,C as r,q as l,t as n,b as i,v,aI as Q,aJ as L,aK as p,d as F,W as K,O,Q as T}from"./index-Dv-87GdI.js";import{u as U}from"./useMutation-DhbY-5L1.js";import{B as o}from"./badge-95hAwcnP.js";import{T as V,a as $,b as S,c as d,d as z,e as c}from"./table-DMjnPR7m.js";import{S as x}from"./skeleton-BMaZuR9w.js";import{M as G}from"./messages-square-PQj76FVx.js";import{R as J}from"./refresh-cw-BE3VGX5S.js";import{M as f}from"./message-square-uFYLMobp.js";import{M as q}from"./mail-ODTLULHl.js";import{C as Y}from"./circle-check-C1_Cff8L.js";import{S as X}from"./send-CUMU5RIS.js";import{f as N}from"./format-CoLFXwEe.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Z=k("Eye",[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _=k("RotateCcw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]);function ee(t,h){if(h)return e.jsx(Z,{className:"h-4 w-4 text-blue-500"});switch(t){case"queued":return e.jsx(K,{className:"h-4 w-4 text-yellow-500"});case"sent":return e.jsx(X,{className:"h-4 w-4 text-orange-500"});case"delivered":return e.jsx(Y,{className:"h-4 w-4 text-green-500"});case"failed":return e.jsx(F,{className:"h-4 w-4 text-red-500"});default:return e.jsx(f,{className:"h-4 w-4 text-gray-500"})}}function se(t,h){if(h)return e.jsx(o,{className:"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-100",children:"Read"});switch(t){case"queued":return e.jsx(o,{className:"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-100",children:"Queued"});case"sent":return e.jsx(o,{className:"bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-100",children:"Sent"});case"delivered":return e.jsx(o,{className:"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-100",children:"Delivered"});case"failed":return e.jsx(o,{className:"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-100",children:"Failed"});default:return e.jsx(o,{variant:"outline",children:t})}}function ae(t){switch(t){case"whatsapp":return e.jsx(f,{className:"h-4 w-4 text-green-600"});case"email":return e.jsx(q,{className:"h-4 w-4 text-blue-600"});default:return e.jsx(f,{className:"h-4 w-4 text-gray-500"})}}function je(){var A,M,C;const{toast:t}=W(),[h,R]=E.useState("all"),{data:s,isLoading:m,refetch:H}=g({queryKey:["/api/admin/messages/stats"]}),{data:u,isLoading:I,refetch:B}=g({queryKey:["/api/admin/messages"]}),{data:b}=g({queryKey:["/api/admin/conversations/unread-count"],refetchInterval:3e4}),w=U({mutationFn:a=>O("POST",`/api/admin/messages/${a}/retry`),onSuccess:()=>{t({title:"Retry Initiated",description:"Message has been queued for retry"}),T.invalidateQueries({queryKey:["/api/admin/messages"]}),T.invalidateQueries({queryKey:["/api/admin/messages/stats"]})},onError:a=>{t({title:"Retry Failed",description:a.message||"Failed to retry message",variant:"destructive"})}}),D=()=>{H(),B(),t({title:"Refreshed",description:"Message data has been refreshed"})},j=u==null?void 0:u.filter(a=>{switch(h){case"queued":return a.status==="queued";case"sent":return a.status==="sent";case"delivered":return a.status==="delivered";case"read":return a.readAt!==null;case"failed":return a.status==="failed";default:return!0}});return e.jsxs("div",{className:"container mx-auto p-6 max-w-7xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold mb-2",children:"WhatsApp Messages"}),e.jsx("p",{className:"text-muted-foreground",children:"Monitor message delivery status and manage failed messages"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(P,{href:"/admin/chats",children:e.jsxs(y,{variant:"outline",className:"relative","data-testid":"link-admin-chats",children:[e.jsx(G,{className:"mr-2 h-4 w-4"}),"Chats",b&&b.unreadConversations>0&&e.jsx(o,{className:"absolute -top-2 -right-2 h-5 min-w-[20px] px-1 bg-red-500 text-white text-xs","data-testid":"badge-unread-chats",children:b.unreadConversations})]})}),e.jsxs(y,{onClick:D,variant:"outline","data-testid":"button-refresh-messages",children:[e.jsx(J,{className:"mr-2 h-4 w-4"}),"Refresh"]})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-6 mb-6",children:[e.jsxs(r,{children:[e.jsx(l,{className:"pb-2",children:e.jsx(n,{className:"text-sm font-medium text-muted-foreground",children:"Total"})}),e.jsx(i,{children:m?e.jsx(x,{className:"h-8 w-16"}):e.jsx("div",{className:"text-2xl font-bold",children:(s==null?void 0:s.total)||0})})]}),e.jsxs(r,{children:[e.jsx(l,{className:"pb-2",children:e.jsx(n,{className:"text-sm font-medium text-yellow-600",children:"Queued"})}),e.jsx(i,{children:m?e.jsx(x,{className:"h-8 w-16"}):e.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:(s==null?void 0:s.queued)||0})})]}),e.jsxs(r,{children:[e.jsx(l,{className:"pb-2",children:e.jsx(n,{className:"text-sm font-medium text-orange-600",children:"Sent"})}),e.jsx(i,{children:m?e.jsx(x,{className:"h-8 w-16"}):e.jsx("div",{className:"text-2xl font-bold text-orange-600",children:(s==null?void 0:s.sent)||0})})]}),e.jsxs(r,{children:[e.jsx(l,{className:"pb-2",children:e.jsx(n,{className:"text-sm font-medium text-green-600",children:"Delivered"})}),e.jsx(i,{children:m?e.jsx(x,{className:"h-8 w-16"}):e.jsx("div",{className:"text-2xl font-bold text-green-600",children:(s==null?void 0:s.delivered)||0})})]}),e.jsxs(r,{children:[e.jsx(l,{className:"pb-2",children:e.jsx(n,{className:"text-sm font-medium text-blue-600",children:"Read"})}),e.jsx(i,{children:m?e.jsx(x,{className:"h-8 w-16"}):e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:(s==null?void 0:s.read)||0})})]}),e.jsxs(r,{children:[e.jsx(l,{className:"pb-2",children:e.jsx(n,{className:"text-sm font-medium text-red-600",children:"Failed"})}),e.jsx(i,{children:m?e.jsx(x,{className:"h-8 w-16"}):e.jsx("div",{className:"text-2xl font-bold text-red-600",children:(s==null?void 0:s.failed)||0})})]})]}),e.jsxs(r,{className:"mb-6",children:[e.jsxs(l,{children:[e.jsx(n,{children:"Messages by Type"}),e.jsx(v,{children:"Distribution of messages across different channels"})]}),e.jsx(i,{children:e.jsxs("div",{className:"flex gap-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(f,{className:"h-5 w-5 text-green-600"}),e.jsx("span",{className:"font-medium",children:"WhatsApp:"}),e.jsx("span",{className:"text-muted-foreground",children:((A=s==null?void 0:s.byType)==null?void 0:A.whatsapp)||0})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{className:"h-5 w-5 text-blue-600"}),e.jsx("span",{className:"font-medium",children:"Email:"}),e.jsx("span",{className:"text-muted-foreground",children:((M=s==null?void 0:s.byType)==null?void 0:M.email)||0})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(f,{className:"h-5 w-5 text-purple-600"}),e.jsx("span",{className:"font-medium",children:"LINE:"}),e.jsx("span",{className:"text-muted-foreground",children:((C=s==null?void 0:s.byType)==null?void 0:C.line)||0})]})]})})]}),e.jsxs(r,{children:[e.jsxs(l,{children:[e.jsx(n,{children:"Message History"}),e.jsx(v,{children:"View and manage all broadcast messages"})]}),e.jsxs(i,{children:[e.jsx(Q,{value:h,onValueChange:R,className:"mb-4",children:e.jsxs(L,{children:[e.jsxs(p,{value:"all","data-testid":"tab-all",children:["All (",(u==null?void 0:u.length)||0,")"]}),e.jsxs(p,{value:"queued","data-testid":"tab-queued",children:["Queued (",(s==null?void 0:s.queued)||0,")"]}),e.jsxs(p,{value:"sent","data-testid":"tab-sent",children:["Sent (",(s==null?void 0:s.sent)||0,")"]}),e.jsxs(p,{value:"delivered","data-testid":"tab-delivered",children:["Delivered (",(s==null?void 0:s.delivered)||0,")"]}),e.jsxs(p,{value:"read","data-testid":"tab-read",children:["Read (",(s==null?void 0:s.read)||0,")"]}),e.jsxs(p,{value:"failed","data-testid":"tab-failed",children:["Failed (",(s==null?void 0:s.failed)||0,")"]})]})}),I?e.jsx("div",{className:"space-y-2",children:[1,2,3,4,5].map(a=>e.jsx(x,{className:"h-16 w-full"},a))}):(j==null?void 0:j.length)===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No messages found in this category"}):e.jsx("div",{className:"rounded-md border",children:e.jsxs(V,{children:[e.jsx($,{children:e.jsxs(S,{children:[e.jsx(d,{className:"w-12",children:"Type"}),e.jsx(d,{children:"Hospital"}),e.jsx(d,{children:"Recipient"}),e.jsx(d,{children:"Pet"}),e.jsx(d,{children:"Status"}),e.jsx(d,{children:"Timestamps"}),e.jsx(d,{className:"w-24",children:"Actions"})]})}),e.jsx(z,{children:j==null?void 0:j.map(a=>e.jsxs(S,{"data-testid":`row-message-${a.id}`,children:[e.jsx(c,{children:ae(a.messageType)}),e.jsx(c,{className:"font-medium",children:a.hospitalName}),e.jsx(c,{className:"font-mono text-sm",children:a.recipient}),e.jsx(c,{children:a.petInfo?e.jsxs("span",{className:"text-sm",children:[a.petInfo.name," (",a.petInfo.species,")"]}):e.jsx("span",{className:"text-muted-foreground text-sm",children:"-"})}),e.jsx(c,{children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[ee(a.status,a.readAt),se(a.status,a.readAt)]}),a.errorMessage&&e.jsx("span",{className:"text-xs text-red-500 max-w-xs truncate",title:a.errorMessage,children:a.errorMessage})]})}),e.jsx(c,{children:e.jsxs("div",{className:"flex flex-col text-xs text-muted-foreground gap-0.5",children:[e.jsxs("span",{children:["Created: ",N(new Date(a.createdAt),"MMM d, HH:mm")]}),a.sentAt&&e.jsxs("span",{children:["Sent: ",N(new Date(a.sentAt),"HH:mm:ss")]}),a.deliveredAt&&e.jsxs("span",{children:["Delivered: ",N(new Date(a.deliveredAt),"HH:mm:ss")]}),a.readAt&&e.jsxs("span",{className:"text-blue-600",children:["Read: ",N(new Date(a.readAt),"HH:mm:ss")]})]})}),e.jsx(c,{children:a.status==="failed"&&e.jsxs(y,{size:"sm",variant:"outline",onClick:()=>w.mutate(a.id),disabled:w.isPending,"data-testid":`button-retry-${a.id}`,children:[e.jsx(_,{className:"h-3 w-3 mr-1"}),"Retry"]})})]},a.id))})]})})]})]}),e.jsxs(r,{className:"mt-6",children:[e.jsxs(l,{children:[e.jsx(n,{children:"Manual Engagement with WhatsApp Coexistence"}),e.jsx(v,{children:"Use the same WhatsApp number for automated broadcasts and manual follow-ups"})]}),e.jsxs(i,{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"WhatsApp Coexistence (launched 2024) allows you to use the WhatsApp Business App on your phone simultaneously with the API automation. This means you can:"}),e.jsxs("ul",{className:"list-disc list-inside text-sm text-muted-foreground space-y-1",children:[e.jsx("li",{children:"Receive reply messages from hospitals in your phone's WhatsApp Business App"}),e.jsx("li",{children:"Manually respond to hospital inquiries and coordinate care"}),e.jsx("li",{children:"Continue automated emergency broadcasts via the API"}),e.jsx("li",{children:"View full conversation history on your phone"})]}),e.jsxs("div",{className:"bg-muted p-4 rounded-lg",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Setup Steps:"}),e.jsxs("ol",{className:"list-decimal list-inside text-sm space-y-1",children:[e.jsx("li",{children:"Open Meta Business Suite → WhatsApp Manager"}),e.jsx("li",{children:"Go to Phone Numbers → Your business number"}),e.jsx("li",{children:'Enable "Use WhatsApp Business app" toggle'}),e.jsx("li",{children:"Scan QR code with WhatsApp Business App on your phone"}),e.jsx("li",{children:"Messages sent via API will appear in your app; you can reply manually"})]})]})]})]})]})}export{je as default};
