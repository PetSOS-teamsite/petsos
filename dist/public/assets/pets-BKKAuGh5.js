import{c as de,T as ss,r as p,j as e,W as Pe,a0 as q,u as ce,B as y,a1 as ke,d as ts,ao as le,O as H,a as Ce,h as re,a4 as ae,a6 as Se,ap as De,a7 as ze,a8 as Te,a9 as He,I as ee,E as _e,G as Ke,H as Re,J as $e,K as Ee,Q as B,e as as,f as rs,g as is,a3 as ns,C as he,q as me,t as xe,v as ge,F as ls,w as V,x as F,y as O,z as U,A,D as os,b as fe,o as ds,s as J,aq as je,ad as cs,R as ps}from"./index-B6B5-wqG.js";import{u as Z}from"./useMutation-DUKQItlV.js";import{T as us}from"./textarea-B8jmdzpK.js";import{B as hs,P as ms,a as xs,C as gs,b as fs,c as js,d as vs,e as bs,f as ys,g as ws,h as Ns}from"./BreedCombobox-DHWTv3-7.js";import{A as Le,a as Me,b as Ie,c as Ve,d as Fe,e as Oe,f as Ue,g as Ae}from"./alert-dialog-DGaBQvry.js";import{S as Ps}from"./switch-7TT_84Ex.js";import{A as ks,a as Cs,b as Ss,c as Ds}from"./accordion-CcO1vqnM.js";import{U as oe}from"./upload-DSNnQUDA.js";import{L as qe}from"./loader-circle-BzrSke9v.js";import{F as ve}from"./file-text-CxJ_fM7y.js";import{S as zs}from"./shield-C0Q1aaSd.js";import{D as Ts}from"./download-Bceeuyd0.js";import{T as Be}from"./trash-2-CgsLVNDK.js";import{A as Hs}from"./arrow-left-BpE3PuIj.js";import{P as ne}from"./paw-print-CXCaKFJL.js";import{P as be}from"./plus-DnjqSZ24.js";import{P as _s}from"./pencil-xD7zwg5A.js";import"./search-DTxsAJDX.js";import"./index-CrkzR3wS.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ze=de("Camera",[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ks=de("FileImage",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["circle",{cx:"10",cy:"12",r:"2",key:"737tya"}],["path",{d:"m20 17-1.296-1.296a2.41 2.41 0 0 0-3.408 0L9 22",key:"wt3hpn"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rs=de("File",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}]]),$s={dog:{en:"Dog",zh:"ç‹—"},cat:{en:"Cat",zh:"è²“"}};var pe="Progress",ue=100,[Es,xt]=ss(pe),[Ls,Ms]=Es(pe),Qe=p.forwardRef((r,l)=>{const{__scopeProgress:m,value:d=null,max:a,getValueLabel:P=Is,...f}=r;(a||a===0)&&!ye(a)&&console.error(Vs(`${a}`,"Progress"));const v=ye(a)?a:ue;d!==null&&!we(d,v)&&console.error(Fs(`${d}`,"Progress"));const x=we(d,v)?d:null,u=ie(x)?P(x,v):void 0;return e.jsx(Ls,{scope:m,value:x,max:v,children:e.jsx(Pe.div,{"aria-valuemax":v,"aria-valuemin":0,"aria-valuenow":ie(x)?x:void 0,"aria-valuetext":u,role:"progressbar","data-state":Ge(x,v),"data-value":x??void 0,"data-max":v,...f,ref:l})})});Qe.displayName=pe;var We="ProgressIndicator",Ye=p.forwardRef((r,l)=>{const{__scopeProgress:m,...d}=r,a=Ms(We,m);return e.jsx(Pe.div,{"data-state":Ge(a.value,a.max),"data-value":a.value??void 0,"data-max":a.max,...d,ref:l})});Ye.displayName=We;function Is(r,l){return`${Math.round(r/l*100)}%`}function Ge(r,l){return r==null?"indeterminate":r===l?"complete":"loading"}function ie(r){return typeof r=="number"}function ye(r){return ie(r)&&!isNaN(r)&&r>0}function we(r,l){return ie(r)&&!isNaN(r)&&r<=l&&r>=0}function Vs(r,l){return`Invalid prop \`max\` of value \`${r}\` supplied to \`${l}\`. Only numbers greater than 0 are valid max values. Defaulting to \`${ue}\`.`}function Fs(r,l){return`Invalid prop \`value\` of value \`${r}\` supplied to \`${l}\`. The \`value\` prop must be:
  - a positive number
  - less than the value passed to \`max\` (or ${ue} if no \`max\` prop is set)
  - \`null\` or \`undefined\` if the progress is indeterminate.

Defaulting to \`null\`.`}var Xe=Qe,Os=Ye;const Je=p.forwardRef(({className:r,value:l,...m},d)=>e.jsx(Xe,{ref:d,className:q("relative h-4 w-full overflow-hidden rounded-full bg-secondary",r),...m,children:e.jsx(Os,{className:"h-full w-full flex-1 bg-primary transition-all",style:{transform:`translateX(-${100-(l||0)}%)`}})}));Je.displayName=Xe.displayName;const Us=r=>r<1024?`${r} B`:r<1024*1024?`${(r/1024).toFixed(1)} KB`:`${(r/(1024*1024)).toFixed(1)} MB`,As=()=>Math.random().toString(36).substring(2,11);function qs({onUploadComplete:r,onError:l,maxFileSize:m=10485760,allowedTypes:d=["image/*","application/pdf"],disabled:a=!1,multiple:P=!1}){const{language:f}=ce(),[v,x]=p.useState(!1),[u,b]=p.useState([]),S=p.useRef(null),D=p.useRef(null),z=p.useRef(0),w=p.useRef([]);p.useEffect(()=>()=>{w.current.forEach(s=>{URL.revokeObjectURL(s)}),w.current=[]},[]);const Y=p.useCallback(s=>d.some(n=>{if(n.endsWith("/*")){const c=n.replace("/*","/");return s.type.startsWith(c)}return s.type===n}),[d]),$=p.useCallback(s=>{if(s.size>m){const n=(m/1048576).toFixed(0);return f==="zh-HK"?`æ–‡ä»¶éŽå¤§ï¼Œæœ€å¤§å…è¨± ${n}MB`:`File too large, max ${n}MB allowed`}return Y(s)?null:f==="zh-HK"?"ä¸æ”¯æ´çš„æ–‡ä»¶æ ¼å¼":"Unsupported file format"},[m,Y,f]),G=async s=>{const{file:n,id:c}=s;b(j=>j.map(N=>N.id===c?{...N,status:"uploading",progress:0}:N));try{const j=await H("POST","/api/medical-records/upload-url"),{uploadURL:N}=await j.json();await new Promise((R,I)=>{const k=new XMLHttpRequest;k.withCredentials=!0,k.upload.addEventListener("progress",W=>{if(W.lengthComputable){const t=Math.round(W.loaded/W.total*100);b(i=>i.map(o=>o.id===c?{...o,progress:t}:o))}}),k.onload=()=>{k.status>=200&&k.status<300?R():I(new Error(`Upload failed: ${k.status}`))},k.onerror=()=>I(new Error("Network error")),k.open("PUT",N),k.setRequestHeader("Content-Type",n.type),k.send(n)});const T=N.split("?")[0];b(R=>R.map(I=>I.id===c?{...I,status:"success",progress:100,uploadedUrl:T}:I)),r({url:T,size:n.size,type:n.type})}catch(j){console.error("Upload error:",j);const N=f==="zh-HK"?"ä¸Šå‚³å¤±æ•—ï¼Œè«‹é‡è©¦":"Upload failed, please try again";b(T=>T.map(R=>R.id===c?{...R,status:"error",error:N}:R)),l==null||l(N)}},X=async s=>{const n=[];for(const c of Array.from(s)){const j=$(c);if(j){l==null||l(j);continue}const N=As();let T=null;if(c.type.startsWith("image/")&&(T=URL.createObjectURL(c),w.current.push(T)),n.push({id:N,file:c,previewUrl:T,progress:0,status:"pending"}),!P)break}if(n.length!==0){b(P?c=>[...c,...n]:c=>(c.forEach(j=>{j.previewUrl&&(URL.revokeObjectURL(j.previewUrl),w.current=w.current.filter(N=>N!==j.previewUrl))}),n));for(const c of n)await G(c)}},Q=s=>{s.preventDefault(),s.stopPropagation(),z.current++,s.dataTransfer.items&&s.dataTransfer.items.length>0&&x(!0)},_=s=>{s.preventDefault(),s.stopPropagation(),z.current--,z.current===0&&x(!1)},K=s=>{s.preventDefault(),s.stopPropagation()},se=s=>{if(s.preventDefault(),s.stopPropagation(),x(!1),z.current=0,a)return;const n=s.dataTransfer.files;n&&n.length>0&&X(n)},E=s=>{const n=s.target.files;n&&n.length>0&&X(n),s.target.value=""},h=s=>{b(n=>{const c=n.find(j=>j.id===s);return c!=null&&c.previewUrl&&(URL.revokeObjectURL(c.previewUrl),w.current=w.current.filter(j=>j!==c.previewUrl)),n.filter(j=>j.id!==s)})},L=d.map(s=>s==="application/pdf"?".pdf":(s.startsWith("image/"),s)).join(","),M=u.some(s=>s.status==="uploading"),C=a||M,te=s=>s.type.startsWith("image/")?e.jsx(Ks,{className:"w-6 h-6 text-blue-500"}):e.jsx(Rs,{className:"w-6 h-6 text-gray-500 dark:text-gray-400"});return e.jsxs("div",{className:"space-y-3",children:[e.jsx("input",{ref:S,type:"file",accept:L,onChange:E,className:"hidden",disabled:C,multiple:P,"data-testid":"input-file-drop"}),e.jsx("input",{ref:D,type:"file",accept:"image/*",capture:"environment",onChange:E,className:"hidden",disabled:C,"data-testid":"input-camera-drop"}),u.length===0&&e.jsx("div",{className:q("relative border-2 border-dashed rounded-lg p-6 transition-all duration-200 cursor-pointer","bg-gray-50 dark:bg-gray-800/50",v?"border-blue-500 bg-blue-50 dark:bg-blue-900/20":"border-gray-300 dark:border-gray-600 hover:border-gray-400 dark:hover:border-gray-500",C&&"opacity-50 cursor-not-allowed"),onDragEnter:Q,onDragLeave:_,onDragOver:K,onDrop:se,onClick:()=>{var s;return!C&&((s=S.current)==null?void 0:s.click())},"data-testid":"dropzone-area",children:e.jsxs("div",{className:"flex flex-col items-center justify-center text-center",children:[e.jsx("div",{className:q("w-12 h-12 rounded-full flex items-center justify-center mb-3",v?"bg-blue-100 dark:bg-blue-900/40":"bg-gray-100 dark:bg-gray-700"),children:e.jsx(oe,{className:q("w-6 h-6",v?"text-blue-500":"text-gray-400 dark:text-gray-500")})}),e.jsx("p",{className:q("text-sm font-medium mb-1",v?"text-blue-600 dark:text-blue-400":"text-gray-700 dark:text-gray-300"),children:v?f==="zh-HK"?"æ”¾é–‹ä»¥ä¸Šå‚³æ–‡ä»¶":"Drop to upload":f==="zh-HK"?"æ‹–æ”¾æ–‡ä»¶åˆ°æ­¤è™•æˆ–é»žæ“Šé¸æ“‡":"Drag & drop files here or click to select"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:f==="zh-HK"?`æ”¯æ´åœ–ç‰‡å’ŒPDFï¼Œæœ€å¤§ ${(m/(1024*1024)).toFixed(0)}MB`:`Images and PDFs, max ${(m/(1024*1024)).toFixed(0)}MB`})]})}),u.length===0&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(y,{type:"button",variant:"outline",size:"sm",onClick:()=>{var s;return(s=S.current)==null?void 0:s.click()},disabled:C,className:"flex-1","data-testid":"button-browse-files",children:[e.jsx(oe,{className:"w-4 h-4 mr-2"}),f==="zh-HK"?"é¸æ“‡æ–‡ä»¶":"Browse Files"]}),e.jsxs(y,{type:"button",variant:"outline",size:"sm",onClick:()=>{var s;return(s=D.current)==null?void 0:s.click()},disabled:C,className:"flex-1","data-testid":"button-take-photo-drop",children:[e.jsx(Ze,{className:"w-4 h-4 mr-2"}),f==="zh-HK"?"æ‹ç…§":"Take Photo"]})]}),u.length>0&&e.jsxs("div",{className:"space-y-2",children:[u.map(s=>e.jsxs("div",{className:q("flex items-start gap-3 p-3 rounded-lg border transition-colors",s.status==="error"?"border-red-200 bg-red-50 dark:border-red-900 dark:bg-red-950/20":s.status==="success"?"border-green-200 bg-green-50 dark:border-green-900 dark:bg-green-950/20":"border-gray-200 bg-gray-50 dark:border-gray-700 dark:bg-gray-800"),"data-testid":`file-item-${s.id}`,children:[s.previewUrl?e.jsx("img",{src:s.previewUrl,alt:s.file.name,className:"w-14 h-14 object-cover rounded-md flex-shrink-0"}):e.jsx("div",{className:"w-14 h-14 flex items-center justify-center bg-gray-100 dark:bg-gray-700 rounded-md flex-shrink-0",children:te(s.file)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 dark:text-gray-100 truncate",children:s.file.name}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:Us(s.file.size)})]}),e.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0",children:[s.status==="uploading"&&e.jsx(qe,{className:"w-4 h-4 animate-spin text-blue-500"}),s.status==="success"&&e.jsx(ke,{className:"w-4 h-4 text-green-500"}),s.status==="error"&&e.jsx(ts,{className:"w-4 h-4 text-red-500"}),s.status!=="uploading"&&e.jsx(y,{type:"button",variant:"ghost",size:"sm",onClick:()=>h(s.id),className:"h-7 w-7 p-0","data-testid":`button-remove-file-${s.id}`,children:e.jsx(le,{className:"w-4 h-4"})})]})]}),s.status==="uploading"&&e.jsxs("div",{className:"mt-2",children:[e.jsx(Je,{value:s.progress,className:"h-1.5"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:f==="zh-HK"?`ä¸Šå‚³ä¸­ ${s.progress}%`:`Uploading ${s.progress}%`})]}),s.status==="success"&&e.jsx("p",{className:"text-xs text-green-600 dark:text-green-400 mt-1",children:f==="zh-HK"?"ä¸Šå‚³æˆåŠŸ":"Upload complete"}),s.status==="error"&&e.jsx("p",{className:"text-xs text-red-600 dark:text-red-400 mt-1",children:s.error})]})]},s.id)),!M&&e.jsxs(y,{type:"button",variant:"outline",size:"sm",onClick:()=>{u.forEach(s=>{s.previewUrl&&URL.revokeObjectURL(s.previewUrl)}),w.current=[],b([])},className:"w-full","data-testid":"button-clear-all-files",children:[e.jsx(le,{className:"w-4 h-4 mr-2"}),f==="zh-HK"?"æ¸…é™¤æ‰€æœ‰æ–‡ä»¶":"Clear All"]})]})]})}const Ne=[{value:"blood_test",labelEn:"Blood Test",labelZh:"è¡€æ¶²æª¢æŸ¥"},{value:"xray",labelEn:"X-Ray",labelZh:"Xå…‰"},{value:"vaccination",labelEn:"Vaccination Record",labelZh:"ç–«è‹—è¨˜éŒ„"},{value:"surgery_report",labelEn:"Surgery Report",labelZh:"æ‰‹è¡“å ±å‘Š"},{value:"prescription",labelEn:"Prescription",labelZh:"è™•æ–¹"},{value:"other",labelEn:"Other Document",labelZh:"å…¶ä»–æ–‡ä»¶"}];function Bs({petId:r,petName:l}){const{toast:m}=Ce(),{t:d,language:a}=ce(),[P,f]=p.useState(!1),[v,x]=p.useState(null),[u,b]=p.useState({title:"",documentType:"other",description:""}),[S,D]=p.useState(null),[z,w]=p.useState(0),[Y,$]=p.useState(""),{data:G=[],isLoading:X}=re({queryKey:["/api/pets",r,"medical-records"]}),{data:Q=[]}=re({queryKey:["/api/pets",r,"medical-consents"]}),_=Q.find(s=>s.consentType==="emergency_broadcast"),K=Z({mutationFn:async s=>await(await H("POST","/api/medical-records",s)).json(),onSuccess:()=>{B.invalidateQueries({queryKey:["/api/pets",r,"medical-records"]}),f(!1),b({title:"",documentType:"other",description:""}),D(null),w(0),$(""),m({title:a==="zh-HK"?"è¨˜éŒ„å·²ä¸Šå‚³":"Record Uploaded",description:a==="zh-HK"?"é†«ç™‚è¨˜éŒ„å·²æˆåŠŸå„²å­˜":"Medical record saved successfully"})},onError:s=>{m({title:a==="zh-HK"?"ä¸Šå‚³å¤±æ•—":"Upload Failed",description:s.message,variant:"destructive"})}}),se=Z({mutationFn:async s=>{await H("DELETE",`/api/medical-records/${s}`)},onSuccess:()=>{B.invalidateQueries({queryKey:["/api/pets",r,"medical-records"]}),x(null),m({title:a==="zh-HK"?"è¨˜éŒ„å·²åˆªé™¤":"Record Deleted"})}}),E=Z({mutationFn:async s=>await(await H("PUT",`/api/pets/${r}/medical-consents`,s)).json(),onSuccess:()=>{B.invalidateQueries({queryKey:["/api/pets",r,"medical-consents"]}),m({title:a==="zh-HK"?"è¨­å®šå·²æ›´æ–°":"Settings Updated"})}}),h=s=>{D(s.url),w(s.size),$(s.type)},L=s=>{m({title:a==="zh-HK"?"ä¸Šå‚³å¤±æ•—":"Upload Failed",description:s,variant:"destructive"})},M=()=>{if(!S||!u.title){m({title:a==="zh-HK"?"è«‹å¡«å¯«å¿…è¦è³‡æ–™":"Please fill required fields",description:a==="zh-HK"?"éœ€è¦æ¨™é¡Œå’Œæ–‡ä»¶":"Title and file are required",variant:"destructive"});return}K.mutate({petId:r,title:u.title,documentType:u.documentType,description:u.description,filePath:S,fileSize:z,mimeType:Y,isConfidential:!1})},C=s=>{const n=Ne.find(c=>c.value===s);return n?a==="zh-HK"?n.labelZh:n.labelEn:s},te=s=>s<1024?`${s} B`:s<1024*1024?`${(s/1024).toFixed(1)} KB`:`${(s/(1024*1024)).toFixed(1)} MB`;return e.jsxs(ks,{type:"single",collapsible:!0,className:"mt-4",children:[e.jsxs(Cs,{value:"medical-records",className:"border rounded-lg",children:[e.jsx(Ss,{className:"px-4 hover:no-underline","data-testid":`accordion-medical-records-${r}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ve,{className:"w-4 h-4"}),e.jsx("span",{children:a==="zh-HK"?"é†«ç™‚è¨˜éŒ„":"Medical Records"}),e.jsxs("span",{className:"text-sm text-gray-500",children:["(",G.length,")"]})]})}),e.jsxs(Ds,{className:"px-4 pb-4",children:[e.jsxs("div",{className:"mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(zs,{className:"w-4 h-4 text-blue-600 dark:text-blue-400"}),e.jsx(ae,{htmlFor:`consent-${r}`,className:"text-sm font-medium",children:a==="zh-HK"?"ç·Šæ€¥æƒ…æ³æ™‚åˆ†äº«é†«ç™‚è¨˜éŒ„":"Share records during emergencies"})]}),e.jsx(Ps,{id:`consent-${r}`,checked:(_==null?void 0:_.enabled)??!1,onCheckedChange:s=>{E.mutate({consentType:"emergency_broadcast",enabled:s})},"data-testid":`switch-emergency-consent-${r}`})]}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400 mt-1",children:a==="zh-HK"?"å•Ÿç”¨å¾Œï¼Œæ‚¨çš„å¯µç‰©é†«ç™‚è¨˜éŒ„æœƒåœ¨ç·Šæ€¥å»£æ’­æ™‚è‡ªå‹•åˆ†äº«çµ¦é†«é™¢":"When enabled, medical records will be shared with hospitals during emergency broadcasts"})]}),e.jsxs(Se,{open:P,onOpenChange:f,children:[e.jsx(De,{asChild:!0,children:e.jsxs(y,{variant:"outline",size:"sm",className:"mb-4","data-testid":`button-upload-record-${r}`,children:[e.jsx(oe,{className:"w-4 h-4 mr-2"}),a==="zh-HK"?"ä¸Šå‚³è¨˜éŒ„":"Upload Record"]})}),e.jsxs(ze,{children:[e.jsx(Te,{children:e.jsx(He,{children:a==="zh-HK"?`ä¸Šå‚³ ${l} çš„é†«ç™‚è¨˜éŒ„`:`Upload Medical Record for ${l}`})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs(ae,{children:[a==="zh-HK"?"æ¨™é¡Œ":"Title"," *"]}),e.jsx(ee,{value:u.title,onChange:s=>b({...u,title:s.target.value}),placeholder:a==="zh-HK"?"ä¾‹å¦‚ï¼š2024å¹´12æœˆè¡€æ¶²æª¢æŸ¥":"e.g., Blood Test Dec 2024","data-testid":"input-record-title"})]}),e.jsxs("div",{children:[e.jsx(ae,{children:a==="zh-HK"?"æ–‡ä»¶é¡žåž‹":"Document Type"}),e.jsxs(_e,{value:u.documentType,onValueChange:s=>b({...u,documentType:s}),children:[e.jsx(Ke,{"data-testid":"select-document-type",children:e.jsx(Re,{})}),e.jsx($e,{children:Ne.map(s=>e.jsx(Ee,{value:s.value,children:a==="zh-HK"?s.labelZh:s.labelEn},s.value))})]})]}),e.jsxs("div",{children:[e.jsx(ae,{children:a==="zh-HK"?"å‚™è¨»ï¼ˆé¸å¡«ï¼‰":"Notes (Optional)"}),e.jsx(ee,{value:u.description,onChange:s=>b({...u,description:s.target.value}),placeholder:a==="zh-HK"?"ä»»ä½•é¡å¤–èªªæ˜Ž...":"Any additional notes...","data-testid":"input-record-description"})]}),e.jsxs("div",{children:[e.jsxs(ae,{children:[a==="zh-HK"?"æ–‡ä»¶":"File"," *"]}),e.jsx("div",{className:"mt-2",children:e.jsx(qs,{onUploadComplete:h,onError:L,maxFileSize:10485760,allowedTypes:["image/*","application/pdf"],disabled:K.isPending},P?"open":"closed")})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(y,{variant:"outline",onClick:()=>{f(!1),b({title:"",documentType:"other",description:""}),D(null),w(0),$("")},children:a==="zh-HK"?"å–æ¶ˆ":"Cancel"}),e.jsx(y,{onClick:M,disabled:K.isPending||!S||!u.title,"data-testid":"button-save-record",children:K.isPending?a==="zh-HK"?"å„²å­˜ä¸­...":"Saving...":a==="zh-HK"?"å„²å­˜è¨˜éŒ„":"Save Record"})]})]})]})]}),X?e.jsx("div",{className:"text-center py-4 text-gray-500",children:a==="zh-HK"?"è¼‰å…¥ä¸­...":"Loading..."}):G.length===0?e.jsxs("div",{className:"text-center py-4 text-gray-500",children:[e.jsx(ve,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:a==="zh-HK"?"å°šç„¡é†«ç™‚è¨˜éŒ„":"No medical records yet"})]}):e.jsx("div",{className:"space-y-2",children:G.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg","data-testid":`record-item-${s.id}`,children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium truncate",children:s.title}),e.jsxs("div",{className:"text-xs text-gray-500 flex items-center gap-2",children:[e.jsx("span",{children:C(s.documentType)}),e.jsx("span",{children:"â€¢"}),e.jsx("span",{children:te(s.fileSize)}),e.jsx("span",{children:"â€¢"}),e.jsx("span",{children:new Date(s.uploadedAt).toLocaleDateString()})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(y,{variant:"ghost",size:"sm",onClick:()=>window.open(s.filePath,"_blank"),"data-testid":`button-download-record-${s.id}`,children:e.jsx(Ts,{className:"w-4 h-4"})}),e.jsx(y,{variant:"ghost",size:"sm",onClick:()=>x(s.id),"data-testid":`button-delete-record-${s.id}`,children:e.jsx(Be,{className:"w-4 h-4 text-red-500"})})]})]},s.id))})]})]}),e.jsx(Le,{open:!!v,onOpenChange:()=>x(null),children:e.jsxs(Me,{children:[e.jsxs(Ie,{children:[e.jsx(Ve,{children:a==="zh-HK"?"åˆªé™¤è¨˜éŒ„":"Delete Record"}),e.jsx(Fe,{children:a==="zh-HK"?"ç¢ºå®šè¦åˆªé™¤é€™ä»½é†«ç™‚è¨˜éŒ„å—Žï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚":"Are you sure you want to delete this medical record? This action cannot be undone."})]}),e.jsxs(Oe,{children:[e.jsx(Ue,{children:a==="zh-HK"?"å–æ¶ˆ":"Cancel"}),e.jsx(Ae,{onClick:()=>v&&se.mutate(v),className:"bg-red-500 hover:bg-red-600",children:a==="zh-HK"?"åˆªé™¤":"Delete"})]})]})})]})}const Zs=r=>ds({name:J().min(1,r("pets.validation.name_required","Pet name is required")),species:J().min(1,r("pets.validation.species_required","Species is required")),breed:J().optional(),age:je.number().positive().optional(),weight:je.number().positive().optional(),medicalNotes:J().optional(),lastVisitHospitalId:J().optional(),lastVisitDate:J().optional()});function gt(){const{user:r,isLoading:l}=as(),[,m]=rs(),{toast:d}=Ce(),{t:a,language:P}=ce(),f=Zs(a),[v,x]=p.useState(!1),[u,b]=p.useState(null),[S,D]=p.useState(null),[z,w]=p.useState(""),[Y,$]=p.useState(!1),[G,X]=p.useState("select"),{data:Q,isLoading:_}=re({queryKey:["/api/users",r==null?void 0:r.id],enabled:!!(r!=null&&r.id)}),{data:K=[],isLoading:se}=re({queryKey:["/api/users",r==null?void 0:r.id,"pets"],enabled:!!(r!=null&&r.id)}),{data:E=[]}=re({queryKey:["/api/clinics"]}),h=is({resolver:cs(f),defaultValues:{name:"",species:"",breed:"",age:void 0,weight:void 0,medicalNotes:"",lastVisitHospitalId:void 0,lastVisitDate:void 0}}),L=h.watch("species");p.useEffect(()=>{L&&L!==z&&(w(L),h.setValue("breed",""))},[L,z,h]);const M=Z({mutationFn:async t=>{const i={...t,userId:r==null?void 0:r.id,weight:t.weight!==void 0?String(t.weight):void 0,lastVisitDate:t.lastVisitDate?new Date(t.lastVisitDate).toISOString():void 0,lastVisitHospitalId:t.lastVisitHospitalId&&t.lastVisitHospitalId.trim()!==""?t.lastVisitHospitalId:void 0};return await(await H("POST","/api/pets",i)).json()},onSuccess:(t,i)=>{B.invalidateQueries({queryKey:["/api/users",r==null?void 0:r.id,"pets"]}),ps.trackPetCreation({petType:i.species,breed:i.breed}),d({title:a("pets.success.add","Pet added successfully!"),description:a("pets.success.add_desc","Your pet has been added to your profile.")}),x(!1),h.reset()},onError:t=>{d({title:a("pets.error.add","Failed to add pet"),description:t.message,variant:"destructive"})}}),C=Z({mutationFn:async({id:t,data:i})=>{const o={...i,weight:i.weight!==void 0?String(i.weight):void 0,lastVisitDate:i.lastVisitDate?new Date(i.lastVisitDate).toISOString():void 0,lastVisitHospitalId:i.lastVisitHospitalId&&i.lastVisitHospitalId.trim()!==""?i.lastVisitHospitalId:void 0};return await(await H("PATCH",`/api/pets/${t}`,o)).json()},onSuccess:()=>{B.invalidateQueries({queryKey:["/api/users",r==null?void 0:r.id,"pets"]}),d({title:a("pets.success.update","Pet updated successfully!"),description:a("pets.success.update_desc","Your pet's information has been updated.")}),x(!1),b(null),h.reset()},onError:t=>{d({title:a("pets.error.update","Failed to update pet"),description:t.message,variant:"destructive"})}}),te=Z({mutationFn:async t=>await(await H("DELETE",`/api/pets/${t}`,{})).json(),onSuccess:()=>{B.invalidateQueries({queryKey:["/api/users",r==null?void 0:r.id,"pets"]}),d({title:a("pets.success.delete","Pet removed"),description:a("pets.success.delete_desc","Your pet has been removed from your profile.")}),D(null)},onError:t=>{d({title:a("pets.error.delete","Failed to delete pet"),description:t.message,variant:"destructive"})}}),[s,n]=p.useState(null),c=Z({mutationFn:async({petId:t,file:i})=>{const o=await H("POST",`/api/pets/${t}/photo-upload-url`,{}),{uploadURL:g}=await o.json();if(!(await fetch(g,{method:"PUT",headers:{"Content-Type":i.type},body:i})).ok)throw new Error("Failed to upload photo");const es=g.split("?")[0];return await(await H("POST",`/api/pets/${t}/photo`,{filePath:es})).json()},onSuccess:()=>{B.invalidateQueries({queryKey:["/api/users",r==null?void 0:r.id,"pets"]}),d({title:a("pets.success.photo_upload","Photo uploaded!"),description:a("pets.success.photo_upload_desc","Your pet's photo has been updated.")}),n(null)},onError:t=>{let i=t.message;try{const o=JSON.parse(t.message);o.message?i=o.message:o.error&&(i=o.error)}catch{}d({title:a("pets.error.photo_upload","Failed to upload photo"),description:i,variant:"destructive"}),n(null)}}),j=Z({mutationFn:async t=>await(await H("DELETE",`/api/pets/${t}/photo`,{})).json(),onSuccess:()=>{B.invalidateQueries({queryKey:["/api/users",r==null?void 0:r.id,"pets"]}),d({title:a("pets.success.photo_delete","Photo removed"),description:a("pets.success.photo_delete_desc","Your pet's photo has been removed.")})},onError:t=>{d({title:a("pets.error.photo_delete","Failed to remove photo"),description:t.message,variant:"destructive"})}}),N=(t,i)=>{var g;const o=(g=i.target.files)==null?void 0:g[0];if(o){if(!o.type.startsWith("image/")){d({title:a("pets.error.invalid_file","Invalid file type"),description:a("pets.error.invalid_file_desc","Please select an image file (JPEG, PNG, etc.)"),variant:"destructive"}),i.target.value="";return}if(o.size>5*1024*1024){d({title:a("pets.error.file_too_large","File too large"),description:a("pets.error.file_too_large_desc","Maximum file size is 5MB"),variant:"destructive"}),i.target.value="";return}n(t),c.mutate({petId:t,file:o})}i.target.value=""},T=t=>{u?C.mutate({id:u.id,data:t}):M.mutate(t)},R=t=>{b(t),w(t.species);let i="";if(t.lastVisitDate)try{const o=new Date(t.lastVisitDate);isNaN(o.getTime())||(i=o.toISOString().split("T")[0])}catch(o){console.error("Error formatting date:",o)}h.reset({name:t.name,species:t.species,breed:t.breed||"",age:t.age?Number(t.age):void 0,weight:t.weight?Number(t.weight):void 0,medicalNotes:t.medicalNotes||"",lastVisitHospitalId:t.lastVisitHospitalId||"",lastVisitDate:i}),x(!0)},I=t=>{D(t)},k=()=>{b(null),w(""),X("select"),h.reset(),x(!0)},W=Q&&!Q.email&&!Q.phone;return p.useEffect(()=>{!l&&!_&&(r?W&&m("/profile"):m("/"))},[r,l,_,W,m]),l||_?e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center",children:e.jsx("div",{className:"text-gray-600 dark:text-gray-400",children:a("loading.pets","Loading...")})}):!r||W?null:e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 py-8",children:e.jsxs("div",{className:"max-w-4xl mx-auto px-4",children:[e.jsx("div",{className:"mb-6 flex items-center justify-between",children:e.jsx(ns,{href:"/profile",children:e.jsxs(y,{variant:"ghost",size:"sm","data-testid":"button-back",children:[e.jsx(Hs,{className:"w-4 h-4 mr-2"}),a("pets.back_to_profile","Back to Profile")]})})}),e.jsxs(he,{className:"mb-6",children:[e.jsxs(me,{className:"flex flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(xe,{className:"flex items-center gap-2",children:[e.jsx(ne,{className:"w-6 h-6"}),a("pets.title","My Pets")]}),e.jsx(ge,{children:a("pets.desc","Manage your pets for faster emergency requests")})]}),e.jsxs(Se,{open:v,onOpenChange:x,children:[e.jsx(De,{asChild:!0,children:e.jsxs(y,{onClick:k,"data-testid":"button-add-pet",children:[e.jsx(be,{className:"w-4 h-4 mr-2"}),a("pets.add","Add Pet")]})}),e.jsxs(ze,{children:[e.jsx(Te,{children:e.jsx(He,{children:u?a("pets.edit","Edit Pet"):a("pets.add_new","Add New Pet")})}),e.jsx(ls,{...h,children:e.jsxs("form",{onSubmit:h.handleSubmit(T),className:"space-y-4",children:[e.jsx(V,{control:h.control,name:"name",render:({field:t})=>e.jsxs(F,{children:[e.jsx(O,{children:a("pets.name","Name")}),e.jsx(U,{children:e.jsx(ee,{...t,placeholder:a("pets.name_placeholder","Fluffy"),"data-testid":"input-pet-name"})}),e.jsx(A,{})]})}),e.jsx(V,{control:h.control,name:"species",render:({field:t})=>e.jsxs(F,{children:[e.jsx(O,{children:a("pets.species","Species")}),e.jsxs(_e,{onValueChange:t.onChange,value:t.value,children:[e.jsx(U,{children:e.jsx(Ke,{"data-testid":"select-pet-species",children:e.jsx(Re,{placeholder:a("pets.select_species","Select species")})})}),e.jsx($e,{children:Object.entries($s).map(([i,o])=>e.jsx(Ee,{value:i,"data-testid":`species-${i}`,children:P==="en"?o.en:o.zh},i))})]}),e.jsx(A,{})]})}),e.jsx(V,{control:h.control,name:"breed",render:({field:t})=>e.jsxs(F,{children:[e.jsx(O,{children:a("pets.breed","Breed (Optional)")}),e.jsx(U,{children:e.jsx(hs,{species:z,value:t.value||"",onChange:t.onChange,placeholder:a("pets.select_breed","Select or type breed..."),testId:"combobox-pet-breed"})}),e.jsx(os,{className:"text-xs text-muted-foreground",children:P==="en"?"ðŸ’¡ Can't find your pet's breed? No worries! Just type it in and press Enter.":"ðŸ’¡ æ‰¾ä¸åˆ°å“ç¨®ï¼Ÿæ²’é—œä¿‚ï¼ç›´æŽ¥è¼¸å…¥ç„¶å¾ŒæŒ‰Enterå³å¯ã€‚"}),e.jsx(A,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(V,{control:h.control,name:"age",render:({field:t})=>e.jsxs(F,{children:[e.jsx(O,{children:a("pets.age","Age (Optional)")}),e.jsx(U,{children:e.jsx(ee,{...t,type:"number",placeholder:a("pets.age_placeholder","3"),"data-testid":"input-pet-age"})}),e.jsx(A,{})]})}),e.jsx(V,{control:h.control,name:"weight",render:({field:t})=>e.jsxs(F,{children:[e.jsx(O,{children:a("pets.weight","Weight (kg, Optional)")}),e.jsx(U,{children:e.jsx(ee,{...t,type:"number",step:"0.1",placeholder:a("pets.weight_placeholder","10.5"),"data-testid":"input-pet-weight"})}),e.jsx(A,{})]})})]}),e.jsx(V,{control:h.control,name:"medicalNotes",render:({field:t})=>e.jsxs(F,{children:[e.jsx(O,{children:a("pets.medical_notes","Medical Notes (Optional)")}),e.jsx(U,{children:e.jsx(us,{...t,placeholder:a("pets.medical_notes_placeholder","Allergies, medications, conditions..."),rows:3,"data-testid":"textarea-pet-medical-notes"})}),e.jsx(A,{})]})}),e.jsx(V,{control:h.control,name:"lastVisitHospitalId",render:({field:t})=>{var i,o;return e.jsxs(F,{className:"flex flex-col",children:[e.jsx(O,{children:a("pets.last_visit_clinic","Last Visit Clinic (Optional)")}),e.jsxs(ms,{open:Y,onOpenChange:$,children:[e.jsx(xs,{asChild:!0,children:e.jsx(U,{children:e.jsxs(y,{variant:"outline",role:"combobox",className:q("w-full justify-between",!t.value&&"text-muted-foreground"),"data-testid":"button-select-clinic",children:[t.value?((i=E.find(g=>g.id===t.value))==null?void 0:i[P==="en"?"name":"nameZh"])||((o=E.find(g=>g.id===t.value))==null?void 0:o.name):a("pets.last_visit_clinic_placeholder","Search clinic..."),e.jsx(gs,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})})}),e.jsx(fs,{className:"w-[400px] p-0",children:e.jsxs(js,{children:[e.jsx(vs,{placeholder:a("pets.last_visit_clinic_placeholder","Search clinic...")}),e.jsxs(bs,{children:[e.jsx(ys,{children:a("pets.no_clinic_selected","No clinic selected")}),e.jsx(ws,{children:E.map(g=>e.jsxs(Ns,{value:g.name,onSelect:()=>{h.setValue("lastVisitHospitalId",g.id),$(!1)},"data-testid":`clinic-${g.id}`,children:[e.jsx(ke,{className:q("mr-2 h-4 w-4",g.id===t.value?"opacity-100":"opacity-0")}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:P==="en"?g.name:g.nameZh||g.name}),e.jsx("div",{className:"text-sm text-gray-500",children:P==="en"?g.address:g.addressZh||g.address})]})]},g.id))})]})]})})]}),e.jsx(A,{})]})}}),e.jsx(V,{control:h.control,name:"lastVisitDate",render:({field:t})=>e.jsxs(F,{children:[e.jsx(O,{children:a("pets.last_visit_date","Last Visit Date (Optional)")}),e.jsx(U,{children:e.jsx(ee,{...t,type:"date","data-testid":"input-last-visit-date"})}),e.jsx(A,{})]})}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(y,{type:"button",variant:"outline",onClick:()=>{x(!1),b(null),h.reset()},"data-testid":"button-cancel-pet",children:a("button.cancel","Cancel")}),e.jsx(y,{type:"submit",disabled:M.isPending||C.isPending,"data-testid":"button-save-pet",children:M.isPending||C.isPending?a("pets.saving","Saving..."):u?a("pets.update","Update Pet"):a("pets.add","Add Pet")})]})]})})]})]})]}),e.jsx(fe,{children:se?e.jsx("div",{className:"text-center py-8 text-gray-500 dark:text-gray-400",children:a("loading.pets","Loading pets...")}):K.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ne,{className:"w-12 h-12 mx-auto mb-4 text-gray-300 dark:text-gray-600"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mb-4",children:a("pets.no_pets","No pets added yet")}),e.jsxs(y,{onClick:k,"data-testid":"button-add-first-pet",children:[e.jsx(be,{className:"w-4 h-4 mr-2"}),a("pets.add_first","Add Your First Pet")]})]}):e.jsx("div",{className:"grid gap-4 md:grid-cols-2",children:K.map(t=>e.jsxs(he,{"data-testid":`card-pet-${t.id}`,children:[e.jsx(me,{className:"pb-2",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsxs("div",{className:"relative flex-shrink-0",children:[e.jsx("div",{className:"w-20 h-20 rounded-full overflow-hidden bg-gray-100 dark:bg-gray-800 border-2 border-gray-200 dark:border-gray-700",children:t.photoUrl?e.jsx("img",{src:t.photoUrl,alt:t.name,className:"w-full h-full object-cover","data-testid":`img-pet-photo-${t.id}`}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx(ne,{className:"w-8 h-8 text-gray-400 dark:text-gray-500"})})}),e.jsxs("label",{className:"absolute bottom-0 right-0 w-7 h-7 bg-primary hover:bg-primary/90 rounded-full flex items-center justify-center cursor-pointer shadow-lg border-2 border-white dark:border-gray-900","data-testid":`button-upload-photo-${t.id}`,children:[s===t.id?e.jsx(qe,{className:"w-4 h-4 text-white animate-spin"}):e.jsx(Ze,{className:"w-4 h-4 text-white"}),e.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:i=>N(t.id,i),disabled:s===t.id,"data-testid":`input-photo-${t.id}`})]}),t.photoUrl&&!s&&e.jsx("button",{className:"absolute top-0 right-0 w-5 h-5 bg-red-500 hover:bg-red-600 rounded-full flex items-center justify-center shadow-sm",onClick:()=>j.mutate(t.id),"data-testid":`button-remove-photo-${t.id}`,children:e.jsx(le,{className:"w-3 h-3 text-white"})})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs(xe,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"truncate",children:t.name}),e.jsxs("div",{className:"flex gap-1 flex-shrink-0",children:[e.jsx(y,{variant:"ghost",size:"sm",onClick:()=>R(t),"data-testid":`button-edit-pet-${t.id}`,children:e.jsx(_s,{className:"w-4 h-4"})}),e.jsx(y,{variant:"ghost",size:"sm",onClick:()=>I(t.id),"data-testid":`button-delete-pet-${t.id}`,children:e.jsx(Be,{className:"w-4 h-4 text-red-500 dark:text-red-400"})})]})]}),e.jsxs(ge,{children:[t.species,t.breed&&` â€¢ ${t.breed}`]})]})]})}),e.jsxs(fe,{children:[e.jsxs("div",{className:"text-sm text-gray-600 dark:text-gray-400 space-y-1",children:[t.age&&e.jsx("div",{children:a("pets.age_years","Age: {age} years").replace("{age}",String(t.age))}),t.weight&&e.jsx("div",{children:a("pets.weight_kg","Weight: {weight} kg").replace("{weight}",String(t.weight))}),t.medicalNotes&&e.jsxs("div",{className:"mt-2 p-2 bg-yellow-50 dark:bg-yellow-900/20 rounded text-yellow-800 dark:text-yellow-200",children:[e.jsx("strong",{children:a("pets.medical_label","Medical:")})," ",t.medicalNotes]})]}),e.jsx(Bs,{petId:t.id,petName:t.name})]})]},t.id))})})]}),e.jsx(Le,{open:!!S,onOpenChange:()=>D(null),children:e.jsxs(Me,{children:[e.jsxs(Ie,{children:[e.jsx(Ve,{children:a("pets.delete","Delete Pet")}),e.jsx(Fe,{children:a("pets.delete_confirm","Are you sure you want to remove this pet from your profile? This action cannot be undone.")})]}),e.jsxs(Oe,{children:[e.jsx(Ue,{"data-testid":"button-cancel-delete",children:a("button.cancel","Cancel")}),e.jsx(Ae,{onClick:()=>S&&te.mutate(S),className:"bg-red-500 hover:bg-red-600 dark:bg-red-600 dark:hover:bg-red-700","data-testid":"button-confirm-delete",children:a("button.delete","Delete")})]})]})})]})})}export{gt as default};
